/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.gygl.cwgl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.action.Base;
import xgxt.form.RequestForm;
import xgxt.form.User;
import xgxt.gygl.gywh.GyglGywhForm;
import xgxt.gygl.gywh.GyglGywhService;
import xgxt.gygl.jbsz.GyglJbszForm;
import xgxt.gygl.jbsz.GyglJbszService;
import xgxt.utils.FormModleCommon;

import com.zfsoft.basic.BasicAction;

/** 
 * MyEclipse Struts
 * Creation date: 05-26-2011
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class GyglCwglAction extends BasicAction {
	/*
	 * Generated Methods
	 */

	/**
	 * 公寓管理_寝室管理_床位自动分配
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward cwzdfp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		GyglCwglForm myForm=(GyglCwglForm)form;
		GyglCwglService service=new GyglCwglService();
		GyglJbszService jbszService = new GyglJbszService();
		RequestForm rForm = new RequestForm();
		GyglJbszForm jbszModel = jbszService.getGyjbszModel();
		GyglCwglInit init=new GyglCwglInit();
		User user = getUser(request);// 用户对象
		String doType=request.getParameter("doType");
		//分配对象
		String fpdx = jbszModel.getFpdx();
		myForm.setFpdx(fpdx);
		//结果集显示字段
		init.getQszdfpRForm(rForm, myForm, request);
		String[] colList = rForm.getColList();
		
		// 结果列表
		ArrayList<String[]> rsArrList = null;
		
		rsArrList = service.getZdfpBmList(myForm, user, colList, request);
		request.setAttribute("searchTj", myForm.getSearchModel());
		
		
		if("zdfp".equalsIgnoreCase(doType)){
			service.cwzdfp(myForm,user);
			request.setAttribute("message", myForm.getMessage());
		}
		
		// =================== 初始化列表值 ===========
		service.setGyglOptionList(myForm, rForm, request);
		// ================= end =====================
		// ============= 设置request的值 =============
		service.setRequestValue(rForm, user, request);
		// =================== end ===================
		request.setAttribute("rsArrList", rsArrList);
		request.setAttribute("path", "gygl_cwgl_zdfp.do");
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("cwzdfp");
	}
	
	/**
	 * 公寓管理_寝室管理_床位配信息查询
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward cwfpxxcx(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		GyglCwglForm myForm=(GyglCwglForm)form;
		GyglCwglService service=new GyglCwglService();
		GyglJbszService jbszService = new GyglJbszService();
		GyglCwglModel model=new  GyglCwglModel();
		RequestForm rForm = new RequestForm();
		GyglJbszForm jbszModel = jbszService.getGyjbszModel();
		GyglCwglInit init=new GyglCwglInit();
		User user = getUser(request);// 用户对象
		
		//分配对象
		String fpdx = jbszModel.getFpdx();
		myForm.setFpdx(fpdx);
		model.setFpdx(fpdx);
		//结果集显示字段
		init.getCwfpxxcxRForm(rForm, myForm, request);
		
		// 结果列表
		ArrayList<String[]> rsArrList = null;
		
		
		if("qxfp".equalsIgnoreCase(rForm.getDoType())){
			boolean result=service.delXszsxx(myForm);
			request.setAttribute("result", result);
			
		}
		
		//统计页面的勾选部门
		String[] pk = myForm.getPrimarykey_checkVal();
		if (pk != null && pk.length > 0) {
			service.setSearchModelValue(fpdx, myForm);
			
		}
		
		
		// 结果集
		rsArrList =(ArrayList<String[]>)service.getXszsxxList(myForm,rForm,user, request);
		request.setAttribute("searchTj", myForm.getSearchModel());
		
		
		//是否存在校区和园区
		request.setAttribute("czxq", jbszModel.getCzxq());
		request.setAttribute("czyq", jbszModel.getCzyq());
		// =================== 初始化列表值 ===========
		service.setGyglOptionList(myForm, rForm, request);
		// ================= end =====================
		// ============= 设置request的值 =============
		rForm.setPath("gygl_cwgl_fpjg.do");
		service.setRequestValue(rForm, user, request);
		// =================== end ===================
		request.setAttribute("rsArrList", rsArrList);
		
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("cwfpxxcx");
	}
	
	/**
	 * 公寓管理_寝室管理_床位自动分配
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward cwsdfp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		GyglCwglForm myForm=(GyglCwglForm)form;
		GyglCwglService service=new GyglCwglService();
		GyglJbszService jbszService = new GyglJbszService();
		RequestForm rForm = new RequestForm();
		GyglJbszForm jbszModel = jbszService.getGyjbszModel();
		GyglCwglInit init=new GyglCwglInit();
		User user = getUser(request);// 用户对象

		//分配对象
		String fpdx = jbszModel.getFpdx();
		myForm.setFpdx(fpdx);
		//结果集显示字段
		init.iniCwsdfpRForm(rForm, myForm, request);
		String[] colList = rForm.getColList();
		
		// 结果列表
		ArrayList<String[]> rsArrList = null;
		//是否查询操作
		
		//取消床位分配
		if("qxfp".equalsIgnoreCase(rForm.getDoType())){
			boolean result=service.delXszsxx(myForm);
			request.setAttribute("result", result);
			
		}
		
		String doType=request.getParameter("doType");
		//删除检测加载条件
		if("scjc".equalsIgnoreCase(doType)){
			service.setSearchModel(myForm, request);
		}
		
		
		//统计页面的勾选部门
		String[] pk = myForm.getPrimarykey_checkVal();
		if (pk != null && pk.length > 0) {
			service.setSearchModelValue(fpdx, myForm);
			
		}
		
		
		//结果集
		myForm.getSearchModel().setSearch_tj_cwfp(myForm.getCwfp());
		rsArrList = (ArrayList<String[]>)service.getFpcwList(myForm, user, colList,new String[]{}, request);
		request.setAttribute("searchTj", myForm.getSearchModel());
	
		
		// =================== 初始化列表值 ===========
		service.setGyglOptionList(myForm, rForm, request);
		// ================= end =====================
		
		// ============= 设置request的值 =============
		service.setRequestValue(rForm, user, request);
		request.setAttribute("czxq",jbszModel.getCzxq());
		request.setAttribute("czyq",jbszModel.getCzyq());
		// =================== end ===================
		request.setAttribute("rsArrList", rsArrList);
		return mapping.findForward("cwsdfp");
	}
	
	/**
	 * 公寓管理_寝室管理_按学生分配床位
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward axsfpcw(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		GyglCwglForm myForm=(GyglCwglForm)form;
		GyglCwglService service=new GyglCwglService();
		GyglJbszService jbszService = new GyglJbszService();
		RequestForm rForm = new RequestForm();
		GyglJbszForm jbszModel = jbszService.getGyjbszModel();
		GyglCwglInit init=new GyglCwglInit();
		User user = getUser(request);// 用户对象

		//分配对象
		String fpdx = jbszModel.getFpdx();
		myForm.setFpdx(fpdx);
		//结果集显示字段
		init.iniAxsfpRForm(rForm, myForm, request);
		String[] colList = rForm.getColList();
		
		// 结果列表
		ArrayList<String[]> rsArrList = null;
		//是否查询操作
		
		
		// 结果集
		myForm.getSearchModel().setPath("gygl_cwgl_sdfp.do&searchType=axsfpcw");
		rsArrList = (ArrayList<String[]>)service.getWzsxsList(myForm, user, colList,new String[]{}, request);
		request.setAttribute("searchTj", myForm.getSearchModel());
		
		
		// =================== 初始化列表值 ===========
		service.setGyglOptionList(myForm, rForm, request);
		// ================= end =====================
		
		// ============= 设置request的值 =============
		service.setRequestValue(rForm, user, request);
		// =================== end ===================
		request.setAttribute("rsArrList", rsArrList);
		
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("axsfpcw");
	}
	
	/**
	 * 公寓管理_寝室管理_将床位分配给学生
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward xscwfp(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		GyglCwglForm myForm=(GyglCwglForm)form;
		GyglCwglService service=new GyglCwglService();
		GyglGywhService gywhService=new GyglGywhService();
		GyglJbszService jbszService = new GyglJbszService();
		RequestForm rForm = new RequestForm();
		GyglJbszForm jbszModel = jbszService.getGyjbszModel();
		GyglCwglInit init=new GyglCwglInit();
		User user = getUser(request);// 用户对象 
		
		//分配对象
		String fpdx = jbszModel.getFpdx();
		myForm.setFpdx(fpdx);
		//结果集显示字段
		init.iniXscwfpRForm(rForm, myForm, request);
		
		//保存床位手动分配信息
		if("save".equalsIgnoreCase(rForm.getDoType())){
			request.setAttribute("result", service.saveSdfpcw(myForm));
			myForm.setPkvArr(myForm.getXsxhArr());
			rForm.setDoType("cwfp");
		}
		
		//需要分配床位的学生
		if ("cwfp".equalsIgnoreCase(rForm.getDoType())){
			//需要分配床位的学生
			List<HashMap<String,String>>fpcwxsList=service.getFpcwXs(myForm);
			//楼栋信息列表
			List<HashMap<String,Object>>ldxxxxList=service.getSsxxList(myForm);
			//所在楼栋信息
			GyglGywhForm gywhForm=new GyglGywhForm();
			gywhForm.setCs(null);
			gywhForm.setFpbj("一般");
			List<HashMap<String,String>>qsxxList=gywhService.getQsfpList(gywhForm);
			request.setAttribute("qsxxList", qsxxList);
			request.setAttribute("ldxxxxList", ldxxxxList);
			request.setAttribute("fpcwxsList", fpcwxsList);
		}
		
		
		
		HashMap<String,String>cwxxMap=service.getCwxxMap(myForm);
		request.setAttribute("cwxxMap", cwxxMap);
		// =================== 初始化列表值 ===========
		service.setGyglOptionList(myForm, rForm, request);
		// ================= end =====================
		
		// ============= 设置request的值 =============
		service.setRequestValue(rForm, user, request);
		// =================== end ===================
		request.setAttribute("fpdx", jbszModel.getFpdx());
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("sdfpcw");
	}
	
	/**
	 * 公寓管理_寝室管理_将床位分配给学生
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward sdfpcw(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		GyglCwglForm myForm=(GyglCwglForm)form;
		GyglCwglService service=new GyglCwglService();
		GyglJbszService jbszService = new GyglJbszService();
		RequestForm rForm = new RequestForm();
		GyglJbszForm jbszModel = jbszService.getGyjbszModel();
		GyglCwglInit init=new GyglCwglInit();
		User user = getUser(request);// 用户对象
		
		String xh=request.getParameter("xh");
		
		String pkValue=request.getParameter("pkValue");
		//分配对象
		String fpdx = jbszModel.getFpdx();
		myForm.setFpdx(fpdx);
		//结果集显示字段
		init.iniSdfpcwRForm(rForm, myForm, request);
		String[] colList = rForm.getColList();
		
		// 结果列表
		ArrayList<String[]> rsArrList = null;
		//是否查询操作
		
		// 结果集
		myForm.getSearchModel().setPath("gygl_cwgl_sdfp.do&searchType=xscwfp");
		rsArrList = (ArrayList<String[]>)service.getWfpcwxsList(myForm, user, colList,new String[]{}, request);
		request.setAttribute("searchTj", myForm.getSearchModel());
	
	
		if(!Base.isNull(pkValue)){
			myForm.setPkValue(pkValue);
			request.setAttribute("pkValue", pkValue);
		}
		
		if("cwfp".equalsIgnoreCase(rForm.getDoType())){
			myForm.setXh(xh);
			request.setAttribute("result", service.saveXscw(myForm));
			return new ActionForward("/gyglCwgl.do?method=cwsdfp&doType=query&go=go", false);
		}
		
		HashMap<String,String>cwxxMap=service.getCwxxMap(myForm);
		request.setAttribute("cwxxMap", cwxxMap);
		// =================== 初始化列表值 ===========
		service.setGyglOptionList(myForm, rForm, request);
		// ================= end =====================
		
		// ============= 设置request的值 =============
		service.setRequestValue(rForm, user, request);
		// =================== end ===================
		request.setAttribute("rsArrList", rsArrList);

		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("xscwfp");
	}
	
	
	/**
	 * 公寓管理_床位管理_床位信息统计
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward cwxxtj(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		GyglCwglForm myForm=(GyglCwglForm)form;
		GyglCwglService service=new GyglCwglService();
		GyglJbszService jbszService = new GyglJbszService();
		RequestForm rForm = new RequestForm();
		GyglJbszForm jbszModel = jbszService.getGyjbszModel();
		GyglCwglInit init=new GyglCwglInit();
		User user = getUser(request);// 用户对象
		
		String xh=request.getParameter("xh");
		
		String pkValue=request.getParameter("pkValue");
		//分配对象
		String fpdx = jbszModel.getFpdx();
		myForm.setFpdx(fpdx);
		//结果集显示字段
		init.iniCwtjRForm(rForm, myForm, request);
		String[] colList = rForm.getColList();
		
		// 结果列表
		ArrayList<String[]> rsArrList = null;
		//是否查询操作
		
	
		// 结果集
		myForm.getSearchModel().setPath("gygl_cwgl_sdfp.do");
		rsArrList = (ArrayList<String[]>)service.getBmxxList(myForm, user, colList, request);
		request.setAttribute("searchTj", myForm.getSearchModel());
		
		
		if(!Base.isNull(pkValue)){
			myForm.setPkValue(pkValue);
			request.setAttribute("pkValue", pkValue);
		}
		
		//保存床位手动分配信息
		if("save".equalsIgnoreCase(rForm.getDoType())){
			request.setAttribute("result", service.saveSdfpcw(myForm));
			myForm.setPkvArr(myForm.getXsxhArr());
			rForm.setDoType("cwsdfp");
		}
		
		request.setAttribute("fpdx", fpdx);
		if("cwsdfp".equalsIgnoreCase(rForm.getDoType())){
			GyglGywhService gywhService=new GyglGywhService();
			//将所选择部门中的学生存入FORM中
			if(!(myForm.getPkvArr()!=null && myForm.getPkvArr().length>0)){
				service.getBmfpcwxs(myForm);
			}
			List<HashMap<String,String>>fpcwxsList=service.getFpcwXs(myForm);
			//楼栋信息列表
			List<HashMap<String,Object>>ldxxxxList=service.getSsxxList(myForm);
			//所在楼栋信息
			GyglGywhForm gywhForm=new GyglGywhForm();
			gywhForm.setCs(null);
			gywhForm.setFpbj("一般");
			gywhForm.setFpbm("未分配");
			gywhForm.setFpdx(fpdx);
			gywhForm.setUser(user);
			List<HashMap<String,String>>qsxxList=gywhService.getQsfpList(gywhForm);
			request.setAttribute("qsxxList", qsxxList);
			request.setAttribute("ldxxxxList", ldxxxxList);
			request.setAttribute("fpcwxsList", fpcwxsList);
			return mapping.findForward("sdfpcwByHand");
		}
		
		
		
		if("cwfp".equalsIgnoreCase(rForm.getDoType())){
			myForm.setXh(xh);
			request.setAttribute("result", service.saveXscw(myForm));
			return new ActionForward("/gyglCwgl.do?method=cwsdfp&doType=query&go=go", false);
		}
		
		if("zdfp".equalsIgnoreCase(rForm.getDoType())){
			service.cwzdfp(myForm,user);
			request.setAttribute("message", myForm.getMessage());
		}
		
		HashMap<String,String>cwxxMap=service.getCwxxMap(myForm);
		request.setAttribute("cwxxMap", cwxxMap);
		// =================== 初始化列表值 ===========
		service.setGyglOptionList(myForm, rForm, request);
		// ================= end =====================
		
		// ============= 设置request的值 =============
		service.setRequestValue(rForm, user, request);
		// =================== end ===================
		request.setAttribute("rsArrList", rsArrList);
		
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("cwxxtj");
	} 
	
	/**
	 * 公寓管理_床位管理_学生筛选
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward sxsdfpcwxs(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		GyglCwglForm myForm=(GyglCwglForm)form;
		GyglCwglService service=new GyglCwglService();
		GyglJbszService jbszService = new GyglJbszService();
		RequestForm rForm = new RequestForm();
		GyglJbszForm jbszModel = jbszService.getGyjbszModel();
		GyglCwglInit init=new GyglCwglInit();
		User user = getUser(request);// 用户对象

		//分配对象
		String fpdx = jbszModel.getFpdx();
		myForm.setFpdx(fpdx);
		//结果集显示字段
		init.iniAxsfpRForm(rForm, myForm, request);
		String[] colList = rForm.getColList();
		
		// 结果列表
		ArrayList<String[]> rsArrList = null;
		//是否查询操作
		boolean search = Boolean.parseBoolean(rForm.getSearch());
		
		//统计页面的勾选部门
		String[] pk = myForm.getPrimarykey_checkVal();
		if (pk != null && pk.length > 0) {
			service.setSearchModelValue(fpdx, myForm);
			search = true;
		}
		
		if (search) {
			// 结果集
			myForm.getSearchModel().setPath("gygl_cwgl_sdfp.do&searchType=axsfpcw");
			rsArrList = (ArrayList<String[]>)service.getSxxsList(myForm, user);
			request.setAttribute("searchTj", myForm.getSearchModel());
		} else {
			myForm.getPages().setMaxPage(1);
		}
		
		// =================== 初始化列表值 ===========
		service.setGyglOptionList(myForm, rForm, request);
		// ================= end =====================
		
		// ============= 设置request的值 =============
		service.setRequestValue(rForm, user, request);
		// =================== end ===================
		request.setAttribute("rsArrList", rsArrList);
		
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("sxsdfpcwxs");
	}
	
}