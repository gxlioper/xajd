/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.pjpy.lsxy;

import java.util.HashMap;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.beanutils.BeanUtils;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.action.Base;
import xgxt.pjpy.zjjd.JxjpdxxModel;
import xgxt.pjpy.zjjd.PjpyZjjdService;
import xgxt.utils.FormModleCommon;
import xgxt.utils.String.NullStringException;
import xgxt.utils.String.StringUtils;
import xgxt.wjcf.wjcfutils.CommonAction;

/**
 * <p>
 * Title: 学生工作管理系统
 * </p>
 * <p>
 * Description: 丽水学院评奖评优Action
 * <p>
 * Copyright: Copyright (c) 2010
 * </p>
 * <p>
 * Company: zfsoft
 * </p>
 * <p>
 * Author: 李容
 * </p>
 * <p>
 * Version: 1.0
 * </p>
 * <p>
 * Time: 2010-08-26
 * </p>
 */
public class LsxyPjpyAction extends CommonAction {	

	/** 
	 * 学生综合素质测评成绩汇总表打印
	 * Method printZhszcphzb
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward printZhszcphzb(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		PjpyLsxyForm model = (PjpyLsxyForm) form;
		LsxyPjpyService service = new LsxyPjpyService();
		model.setXn(request.getParameter("xn"));
		model.setXq(request.getParameter("xq"));
		model.setXqmc(request.getParameter("xqmc"));
		model.setBjdm(request.getParameter("bjdm"));
		
		response.reset();
		response.setContentType("application/vnd.ms-excel");
		try{
			//打印学期综合素质测评成绩汇总信息
			service.getZhszcphzb(response.getOutputStream(),model);
		}catch (Exception e) {
			e.printStackTrace();
		}
		return mapping.findForward("");
	}
	
	/** 
	 * 学生奖学金申请
	 * Method jxjSq
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward jxjSq(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		PjpyLsxyForm model = (PjpyLsxyForm) form;
		LsxyPjpyService service = new LsxyPjpyService();
		PjpyZjjdService zjjdService = new PjpyZjjdService();
		HttpSession session = request.getSession();
		String bmdm = session.getAttribute("userDep").toString();
		String userType = session.getAttribute("userType").toString();
		//学院用户
		if (StringUtils.isEqual(userType, "xy")) {
			model.setXydm(bmdm);
		}
		
		String[] jxjsqxnxqnd = zjjdService.getJxjsqxnxqnd();//奖学金申请学年，学期，年度
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		BeanUtils.copyProperties(jxjpdModel, model);
		HashMap<String, String> resMap = new HashMap<String, String>();
		if (jxjsqxnxqnd != null && jxjsqxnxqnd.length == 3) {
			jxjpdModel.setXn(jxjsqxnxqnd[0]);
			jxjpdModel.setXq(jxjsqxnxqnd[1]);
			jxjpdModel.setNd(jxjsqxnxqnd[2]);
		}
		String xh = "";
		if (StringUtils.isEqual(userType, "student") || StringUtils.isEqual(userType, "stu")) {
			xh = session.getAttribute("userName").toString();
			request.setAttribute("showstu", "yes");
		} else {
			xh = request.getParameter("xh");
		}
		jxjpdModel.setXh(xh);
		if (!StringUtils.isNull(xh)) {
			resMap = service.getJxjpdxx(jxjpdModel);//获取学生评定信息
			if (resMap != null) {//该生信息存在
				resMap.put("stuExists", "yes");
			} else {//该生信息不存在
				resMap = new HashMap<String, String>();
				resMap.put("stuExists", "no");
			}
			boolean bCj  = zjjdService.stuCjFlag(xh, jxjpdModel.getXn(), null);//学生是否有成绩
			if (!bCj) {
				request.setAttribute("cjFlag", "no");
			}
		}
		if (jxjsqxnxqnd != null && jxjsqxnxqnd.length == 3) {
			resMap.put("xn", jxjsqxnxqnd[0]);
			resMap.put("xq", jxjsqxnxqnd[1]);//
			resMap.put("nd", jxjsqxnxqnd[2]);//
		}
		appendJxjList(request);//奖学金列表
		request.setAttribute("rs", resMap);
		request.setAttribute("userType", userType);
		request.setAttribute("path", "prise_apply.do");
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("jxjsq");
	}
	
	/**
	 * 奖学金申请保存
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception
	 */
	public ActionForward jxjsqSave(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
	throws Exception {
		PjpyLsxyForm model = (PjpyLsxyForm) form;
		LsxyPjpyService service = new LsxyPjpyService();
		PjpyZjjdService zjjdService = new PjpyZjjdService();
		HttpSession session = request.getSession();
		String bmdm = session.getAttribute("userDep").toString();
		String userType = session.getAttribute("userType").toString();
		//学院用户
		if (StringUtils.isEqual(userType, "xy")) {
			model.setXydm(bmdm);
		}
		
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		BeanUtils.copyProperties(jxjpdModel, model);
		jxjpdModel.setXn(request.getParameter("save_xn"));
		//学年为主键
		jxjpdModel.setNd(request.getParameter("save_nd"));
		jxjpdModel.setXq(request.getParameter("save_xq"));
		jxjpdModel.setJxjdm(request.getParameter("save_jxjdm"));
		
		HashMap<String, String> resMap = new HashMap<String, String>();
		jxjpdModel.setXh(model.getSave_xh());
		resMap = service.getJxjpdxx(jxjpdModel);//获取学生评定信息
		resMap.put("stuExists", "yes");
		
		String[] jxjsqxnxqnd = zjjdService.getJxjsqxnxqnd();//奖学金申请学年，学期，年度
		if (jxjsqxnxqnd != null && jxjsqxnxqnd.length == 3) {
			resMap.put("xn", jxjsqxnxqnd[0]);
			resMap.put("xq", jxjsqxnxqnd[1]);
			resMap.put("nd", jxjsqxnxqnd[2]);
		}
		
		//学生是否有成绩
		boolean bCj  = zjjdService.stuCjFlag(jxjpdModel.getXh(), 
											 jxjpdModel.getXn(), 
											 null);
		if (!bCj) {
			request.setAttribute("cjFlag", "no");
		} else {
			//条件判断
			HashMap<String, String> resultMap = service.pdStuTjFlag(jxjpdModel, "jxj");
			String pdMsg = resultMap.get("result");
			boolean tjFlag = "true".equalsIgnoreCase(pdMsg) ? true : false;
			if (!tjFlag) {
				request.setAttribute("failinfo", "true");
				request.setAttribute("message", resultMap.get("message"));
			} else {
				insertOperation(request, "xsjxjb");//申请保存
				boolean bFlag = (Boolean)request.getAttribute("result");
				if (bFlag) {//成功
					request.setAttribute("inserted", "yes");
				} else {//失败
					request.setAttribute("inserted", "no");					
				}
			}
		}
		appendJxjList(request);//奖学金列表
		request.setAttribute("rs", resMap);
		request.setAttribute("path", "prise_apply.do");
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("jxjsq");
	}
	
	/**
	 * 打印奖学金申请表
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception
	 */
	public ActionForward printJxjsqb(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response){
		LsxyPjpyService service = new LsxyPjpyService();
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		jxjpdModel.setXh(request.getParameter("xh"));
		jxjpdModel.setXn(request.getParameter("xn"));
		List<HashMap<String, String>> xqList = Base.getXqList();
		
		//获取学生评定信息		
		request.setAttribute("rs", service.getJxjpdxx(jxjpdModel));
		
		//获取奖学金信息
		HashMap<String, String> map = service.getXsjxjb(jxjpdModel);
		map.put("jxjmc", StringUtils.isNotNull(request.getParameter("jxjmc")) ? 
				request.getParameter("jxjmc"): map.get("jxjmc"));
		map.put("jfqk", StringUtils.isNotNull(request.getParameter("jfqk")) ? 
				request.getParameter("jfqk"): map.get("jfqk"));
		request.setAttribute("jxjRs", map);
		//第一学期成绩
		jxjpdModel.setXq(xqList.get(0).get("xqdm"));
		List<HashMap<String, String>> list = service.getXscjb(jxjpdModel,"考试");
		request.setAttribute("kscjRs1", list);
		request.setAttribute("kscj1Len", list.size());
		request.setAttribute("kscjRs1Leng", list != null ? 7-list.size() : 7);
		
		list = service.getXscjb(jxjpdModel,"考查");
		request.setAttribute("kccjRs1", list);
		request.setAttribute("kccj1Len", list.size());
		request.setAttribute("kccjRs1Leng", list != null ? 7-list.size() : 7);
		//第二学期成绩
		jxjpdModel.setXq(xqList.get(1).get("xqdm"));
		list = service.getXscjb(jxjpdModel,"考试");
		request.setAttribute("kscjRs2", list);
		request.setAttribute("kscj2Len", list.size());
		request.setAttribute("kscjRs2Leng", list != null ? 7-list.size() : 7);
		
		list = service.getXscjb(jxjpdModel,"考查");
		request.setAttribute("kccjRs2", list);
		request.setAttribute("kccj2Len", list.size());
		request.setAttribute("kccjRs2Leng", list != null ? 7-list.size() : 7);
		return mapping.findForward("printjxjsqb");
	}
	
	/**
	 * 打印荣誉称号申请表
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception
	 */
	public ActionForward printRychsqb(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response){
		LsxyPjpyService service = new LsxyPjpyService();
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		jxjpdModel.setXh(request.getParameter("xh"));
		jxjpdModel.setXn(request.getParameter("xn"));
		List<HashMap<String, String>> xqList = Base.getXqList();
		
		//获取学生评定信息		
		request.setAttribute("rs", service.getJxjpdxx(jxjpdModel));
		
		//获取荣誉称号信息
		HashMap<String, String> map = service.getXsrychb(jxjpdModel);
		map.put("rychmc", StringUtils.isNotNull(request.getParameter("rychmc")) ? 
				request.getParameter("rychmc"): map.get("rychmc"));
		map.put("zysj", StringUtils.isNotNull(request.getParameter("zysj")) ? 
				request.getParameter("zysj"): map.get("zysj"));
		map.put("sfhdjxj", service.getSfhdjxj(jxjpdModel) == true ? "是" : "否");
		request.setAttribute("rychRs", map);
		//第一学期成绩
		jxjpdModel.setXq(xqList.get(0).get("xqdm"));
		List<HashMap<String, String>> list = service.getXscjb(jxjpdModel,"考试");
		request.setAttribute("kscjRs1", list);
		request.setAttribute("kscj1Len", list.size());
		request.setAttribute("kscjRs1Leng", list != null ? 7-list.size() : 7);
		
		list = service.getXscjb(jxjpdModel,"考查");
		request.setAttribute("kccjRs1", list);
		request.setAttribute("kccj1Len", list.size());
		request.setAttribute("kccjRs1Leng", list != null ? 7-list.size() : 7);
		//第二学期成绩
		jxjpdModel.setXq(xqList.get(1).get("xqdm"));
		list = service.getXscjb(jxjpdModel,"考试");
		request.setAttribute("kscjRs2", list);
		request.setAttribute("kscj2Len", list.size());
		request.setAttribute("kscjRs2Leng", list != null ? 7-list.size() : 7);
		
		list = service.getXscjb(jxjpdModel,"考查");
		request.setAttribute("kccjRs2", list);
		request.setAttribute("kccj2Len", list.size());
		request.setAttribute("kccjRs2Leng", list != null ? 7-list.size() : 7);
		return mapping.findForward("printrychsqb");
	}
	
	/**
	 * 奖学金申请信息查询
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 * @throws Exception
	 */
	public ActionForward priseResult(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		PjpyLsxyForm model = (PjpyLsxyForm)form;
		HttpSession session = request.getSession();
		String bmdm = session.getAttribute("userDep").toString();
		String userType = session.getAttribute("userType").toString();
		String xydm = "";
		String tableName = "view_xsjxjb";
		String realTable = "xsjxjb";
		String act = request.getParameter("act");
		//学院用户
		if (StringUtils.isEqual(userType, "xy")) {
			xydm = bmdm;
			model.setXydm(bmdm);
		}else {
			xydm = model.getQueryequals_xydm();
		}
		//学生新用户
		if (StringUtils.isEqual(userType, "student") || StringUtils.isEqual(userType, "stu")) {
			model.setQuerylike_xh(session.getAttribute("userName").toString());
		}
		if(QUERY.equalsIgnoreCase(act)){//查询
			String[] outputColumn = {"pkValue","xn","xh","xm","nj","xymc","zymc","bjmc","jxjmc","xysh","xxsh"};
			selectPageDataByPagination(request, form, realTable, tableName, outputColumn);
		}
		if(DELETE.equalsIgnoreCase(act)){//删除
			deleteOperation(request, realTable);
		}
		
		//加载班级、学年信息
		appendProperties(request, xydm, model.getQueryequals_zydm(), model.getQueryequals_nj());
		//奖学金列表
		appendJxjList(request);
		//读写权跟位置信息
		appendOperQx(request, "prise_result.do");
		//表信息
		appendTableXx(request, tableName, realTable);
		return mapping.findForward("priseresult");
	}
	
	/**
	 * 奖学金信息修改
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 * @throws Exception
	 */
	public ActionForward jxjModi(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		LsxyPjpyService service = new LsxyPjpyService();
		String act = request.getParameter("act");
		String pkValue = request.getParameter("pkValue");
		String tabName = "xsjxjb";
		String viewName = "view_xsjxjb";
		
		if(SAVE.equalsIgnoreCase(act)){//信息保存
			updateOperation(request, tabName);
		}
		
		//查询奖学金信息
		HashMap<String, String> reMap = new HashMap<String, String>();
		selectPageDataByOne(request, tabName, viewName, pkValue);
		reMap = (HashMap<String, String>)request.getAttribute("rs"); 
		
		//查询综合测评信息
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		jxjpdModel.setXh(reMap.get("xh"));
		jxjpdModel.setXn(reMap.get("xn"));
		reMap.putAll(service.getJxjpdxx(jxjpdModel));//获取学生评定信息
		
		request.setAttribute("rs", reMap);
		request.setAttribute("act", act);
		//奖学金列表
		appendJxjList(request);
		//读写权跟位置信息
		appendOperQx(request, "prise_result.do");
		return mapping.findForward("jxjModi");
	}
	
	/**
	 * 奖学金审核
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 * @throws Exception
	 */
	public ActionForward jxjShOne(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		LsxyPjpyService service = new LsxyPjpyService();
		String userType = getUserType(request);
		String act = request.getParameter("act");
		String pkValue = request.getParameter("pkValue");
		String tabName = "xsjxjb";
		String viewName = "view_xsjxjb";
		
		if(SAVE.equalsIgnoreCase(act)){//信息保存
			HashMap<String, String> stuMap = new HashMap<String, String>();
			stuMap = getStuInfo(request.getParameter("save_xh"));
			stuMap.put("jxjdm", request.getParameter("save_jxjdm"));
			stuMap.put("xn", request.getParameter("save_xn"));
			//人数判断
			String shjg = "xy".equalsIgnoreCase(userType) ? request.getParameter("save_xysh")
														  : request.getParameter("save_xxsh");
			boolean rsFlag = true;
			if("通过".equalsIgnoreCase(shjg) && "xy".equalsIgnoreCase(userType)){
				rsFlag = service.checkJxjRsxz(stuMap);
			}
			if(rsFlag){
				updateOperation(request, tabName);
			}else {
				request.setAttribute("result", false);
				request.setAttribute("message", "人数已经超过限制");
			}
		}
		//查询奖学金信息
		HashMap<String, String> reMap = new HashMap<String, String>();
		selectPageDataByOne(request, tabName, viewName, pkValue);
		reMap = (HashMap<String, String>)request.getAttribute("rs"); 
		
		//查询综合测评信息
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		jxjpdModel.setXh(reMap.get("xh"));
		jxjpdModel.setXn(reMap.get("xn"));
		reMap.putAll(service.getJxjpdxx(jxjpdModel));//获取学生评定信息
		
		request.setAttribute("rs", reMap);
		request.setAttribute("act", act);
		//奖学金列表
		appendJxjList(request);
		//读写权跟位置信息
		appendOperQx(request, "prise_check.do");
		//审核列表
		appendChkList(request);
		return mapping.findForward("jxjShOne");
	}
	
	/**
	 * 奖学金申请信息导出
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward expJxj(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		String tableName = "xsjxjb";//奖学金信息表
		String viewName = "view_xsjxjb";
		String[] outputColumn = {"xn","xh","xm","xb","xydm","xymc","zydm","zymc","bjdm",
								 "bjmc","nj","jxjdm","jxjmc","jfqk","bz"};
		expPageData(request, response, tableName, viewName, outputColumn);
		return mapping.findForward("");
	}
	
	/**
	 * 荣誉称号申请
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward rychSq(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		PjpyLsxyForm model = (PjpyLsxyForm) form;
		LsxyPjpyService service = new LsxyPjpyService();
		PjpyZjjdService zjjdService = new PjpyZjjdService();
		HttpSession session = request.getSession();
		String bmdm = session.getAttribute("userDep").toString();
		String userType = session.getAttribute("userType").toString();
		//学院用户
		if (StringUtils.isEqual(userType, "xy")) {
			model.setXydm(bmdm);
		}
		
		String[] jxjsqxnxqnd = zjjdService.getJxjsqxnxqnd();//奖学金申请学年，学期，年度
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		BeanUtils.copyProperties(jxjpdModel, model);
		HashMap<String, String> resMap = new HashMap<String, String>();
		if (jxjsqxnxqnd != null && jxjsqxnxqnd.length == 3) {
			jxjpdModel.setXn(jxjsqxnxqnd[0]);
			jxjpdModel.setXq(jxjsqxnxqnd[1]);
			jxjpdModel.setNd(jxjsqxnxqnd[2]);
		}
		String xh = "";
		if (StringUtils.isEqual(userType, "student") || StringUtils.isEqual(userType, "stu")) {
			xh = session.getAttribute("userName").toString();
			request.setAttribute("showstu", "yes");
		} else {
			xh = request.getParameter("xh");
		}
		jxjpdModel.setXh(xh);
		if (!StringUtils.isNull(xh)) {
			resMap = service.getJxjpdxx(jxjpdModel);//获取学生评定信息
			if (resMap != null) {//该生信息存在
				resMap.put("stuExists", "yes");
			} else {//该生信息不存在
				resMap = new HashMap<String, String>();
				resMap.put("stuExists", "no");
			}
			boolean bCj  = zjjdService.stuCjFlag(xh, jxjpdModel.getXn(), null);//学生是否有成绩
			if (!bCj) {
				request.setAttribute("cjFlag", "no");
			}
		}
		if (jxjsqxnxqnd != null && jxjsqxnxqnd.length == 3) {
			resMap.put("xn", jxjsqxnxqnd[0]);
			resMap.put("xq", jxjsqxnxqnd[1]);
			resMap.put("nd", jxjsqxnxqnd[2]);
		}
		appendRychList(request);//荣誉称号列表
		request.setAttribute("rs", resMap);
		request.setAttribute("userType", userType);
		request.setAttribute("path", "credit_apply.do");
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("rychsq");
	}
	
	/**
	 * 荣誉称号申请保存
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception
	 */
	public ActionForward rychsqSave(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
	throws Exception {
		PjpyLsxyForm model = (PjpyLsxyForm) form;
		LsxyPjpyService service = new LsxyPjpyService();
		PjpyZjjdService zjjdService = new PjpyZjjdService();
		HttpSession session = request.getSession();
		String bmdm = session.getAttribute("userDep").toString();
		String userType = session.getAttribute("userType").toString();
		//学院用户
		if (StringUtils.isEqual(userType, "xy")) {
			model.setXydm(bmdm);
		}
		
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		BeanUtils.copyProperties(jxjpdModel, model);
		jxjpdModel.setXn(request.getParameter("save_xn"));
		//学年为主键
		jxjpdModel.setNd(request.getParameter("save_nd"));//
		jxjpdModel.setXq(request.getParameter("save_nq"));
		jxjpdModel.setJxjdm(request.getParameter("save_rychdm"));
		
		HashMap<String, String> resMap = new HashMap<String, String>();
		jxjpdModel.setXh(model.getSave_xh());
		resMap = service.getJxjpdxx(jxjpdModel);//获取学生评定信息
		resMap.put("stuExists", "yes");
		
		String[] jxjsqxnxqnd = zjjdService.getJxjsqxnxqnd();//奖学金申请学年，学期，年度
		if (jxjsqxnxqnd != null && jxjsqxnxqnd.length == 3) {
			resMap.put("xn", jxjsqxnxqnd[0]);
			resMap.put("xq", jxjsqxnxqnd[1]);//
			resMap.put("nd", jxjsqxnxqnd[2]);//
		}
		
		//学生是否有成绩
		boolean bCj  = zjjdService.stuCjFlag(jxjpdModel.getXh(), 
											 jxjpdModel.getXn(), 
											 null);
		if (!bCj) {
			request.setAttribute("cjFlag", "no");
		} else {
			//条件判断
			HashMap<String, String> resultMap = service.pdStuTjFlag(jxjpdModel, "rych");
			String pdMsg = resultMap.get("result");
			boolean tjFlag = "true".equalsIgnoreCase(pdMsg) ? true : false;
			if (!tjFlag) {
				request.setAttribute("failinfo", "true");
				request.setAttribute("message", resultMap.get("message"));
			} else {
				insertOperation(request, "xsrychb");//申请保存
				boolean bFlag = (Boolean)request.getAttribute("result");
				if (bFlag) {//成功
					request.setAttribute("inserted", "yes");
				} else {//失败
					request.setAttribute("inserted", "no");					
				}
			}
		}
		appendRychList(request);//荣誉称号列表
		request.setAttribute("rs", resMap);
		request.setAttribute("path", "prise_apply.do");
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("rychsq");
	}
	
	
	/**
	 * 荣誉称号申请信息查询
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward rychResult(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		PjpyLsxyForm model = (PjpyLsxyForm)form;
		HttpSession session = request.getSession();
		String bmdm = session.getAttribute("userDep").toString();
		String userType = session.getAttribute("userType").toString();
		String xydm = "";
		String tableName = "view_xsrychb";
		String realTable = "xsrychb";
		String act = request.getParameter("act");
		//学院用户
		if (StringUtils.isEqual(userType, "xy")) {
			xydm = bmdm;
			model.setXydm(bmdm);
		}else {
			xydm = model.getQueryequals_xydm();
		}
		//学生新用户
		if (StringUtils.isEqual(userType, "student") || StringUtils.isEqual(userType, "stu")) {
			model.setQuerylike_xh(session.getAttribute("userName").toString());
		}
		if(QUERY.equalsIgnoreCase(act)){//查询
			String[] outputColumn = {"pkValue","xn","xh","xm","nj","xymc","zymc","bjmc","rychmc","xysh","xxsh"};
			selectPageDataByPagination(request, form, realTable, tableName, outputColumn);
		}
		if(DELETE.equalsIgnoreCase(act)){//删除
			deleteOperation(request, realTable);
		}
		
		//加载班级、学年信息
		appendProperties(request, xydm, model.getQueryequals_zydm(), model.getQueryequals_nj());
		//荣誉称号列表
		appendRychList(request);
		//读写权跟位置信息
		appendOperQx(request, "credit_result.do");
		//表信息
		appendTableXx(request, tableName, realTable);
		return mapping.findForward("rychresult");
	}
	
	/**
	 * 荣誉称号信息修改
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward rychModi(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		LsxyPjpyService service = new LsxyPjpyService();
		String act = request.getParameter("act");
		String pkValue = request.getParameter("pkValue");
		String tabName = "xsrychb";
		String viewName = "view_xsrychb";
		
		if(SAVE.equalsIgnoreCase(act)){//信息保存
			updateOperation(request, tabName);
		}
		
		//查询荣誉称号信息
		HashMap<String, String> reMap = new HashMap<String, String>();
		selectPageDataByOne(request, tabName, viewName, pkValue);
		reMap = (HashMap<String, String>)request.getAttribute("rs"); 
		
		//查询综合测评信息
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		jxjpdModel.setXh(reMap.get("xh"));
		jxjpdModel.setXn(reMap.get("xn"));
		reMap.putAll(service.getJxjpdxx(jxjpdModel));//获取学生评定信息
		
		request.setAttribute("rs", reMap);
		request.setAttribute("act", act);
		//荣誉称号列表
		appendRychList(request);
		//读写权跟位置信息
		appendOperQx(request, "credit_result.do");
		return mapping.findForward("rychModi");
	}
	
	/**
	 * 荣誉称号审核
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward rychShOne(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		LsxyPjpyService service = new LsxyPjpyService();
		String userType = getUserType(request);
		String act = request.getParameter("act");
		String pkValue = request.getParameter("pk");
		String tabName = "xsrychb";
		String viewName = "view_xsrychb";		
		
		if(SAVE.equalsIgnoreCase(act)){//信息保存
			HashMap<String, String> stuMap = new HashMap<String, String>();
			stuMap = getStuInfo(request.getParameter("save_xh"));
			stuMap.put("xn", request.getParameter("save_xn"));
			stuMap.put("jxjdm", request.getParameter("save_rychdm"));
			
			//人数判断
			String shjg = "xy".equalsIgnoreCase(userType) ? request.getParameter("save_xysh")
														  : request.getParameter("save_xxsh");
			boolean rsFlag = true;
			if("通过".equalsIgnoreCase(shjg) && "xy".equalsIgnoreCase(userType)){
				rsFlag = service.checkRychRsxz(stuMap);
			}
			if(rsFlag){
				updateOperation(request, tabName);
			}else {
				request.setAttribute("result", false);
				request.setAttribute("message", "人数已经超过限制！");
			}
		}
		//查询荣誉称号信息
		HashMap<String, String> reMap = new HashMap<String, String>();
		selectPageDataByOne(request, tabName, viewName, pkValue);
		reMap = (HashMap<String, String>)request.getAttribute("rs"); 
		
		//查询综合测评信息
		JxjpdxxModel jxjpdModel = new JxjpdxxModel();
		jxjpdModel.setXh(reMap.get("xh"));
		jxjpdModel.setXn(reMap.get("xn"));
		reMap.putAll(service.getJxjpdxx(jxjpdModel));//获取学生评定信息
		
		request.setAttribute("rs", reMap);
		request.setAttribute("act", act);
		//荣誉称号列表
		appendRychList(request);
		//读写权跟位置信息
		appendOperQx(request, "credit_result.do");
		//审核列表
		appendChkList(request);
		return mapping.findForward("rychShOne");
	}
	
	/**
	 * 荣誉称号申请信息导出
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward expRych(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		String tableName = "xsrychb";//荣誉称号信息表
		String viewName = "view_xsrychb";
		String[] outputColumn = {"xn","xh","xm","xb","xydm","xymc","zydm","zymc","bjdm",
								 "bjmc","nj","rychdm","rychmc","zysj","bz"};
		expPageData(request, response, tableName, viewName, outputColumn);
		return mapping.findForward("");
	}
	
	/**
	 * 成绩信息查询
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception
	 */
	public ActionForward cjfcx(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		PjpyLsxyForm model = (PjpyLsxyForm)form;
		HttpSession session = request.getSession();
		String bmdm = session.getAttribute("userDep").toString();
		String userType = session.getAttribute("userType").toString();
		String xydm = "";
		String tableName = "view_lsxy_cjb";
		String realTable = null;
		String act = request.getParameter("act");
		//学院用户
		if (StringUtils.isEqual(userType, "xy")) {
			xydm = bmdm;
			model.setXydm(bmdm);
		}else {
			xydm = model.getQueryequals_xydm();
		}
		//学生用户
		if (StringUtils.isEqual(userType, "student") || StringUtils.isEqual(userType, "stu")) {
			model.setQuerylike_xh(session.getAttribute("userName").toString());
		}
		if(QUERY.equalsIgnoreCase(act)){//查询
			String[] outputColumn = {"pk","xn","xqmc","xh","xm","nj","xymc","zymc","bjmc","cj"};
			selectPageDataByPagination(request, form, realTable, tableName, outputColumn);
		}
		
		//加载班级、学年信息
		appendProperties(request, xydm, model.getQueryequals_zydm(), model.getQueryequals_nj());		
		//读写权跟位置信息
		appendOperQx(request, "pjpyLsxy.do?method=cjfcx");
		//表信息
		appendTableXx(request, tableName, realTable);
		return mapping.findForward("cjfcx");
	}
	
	/**
	 * 成绩信息导出
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward expCjf(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		String tableName = null;
		String viewName = "view_lsxy_cjb";
		String[] outputColumn = {"xn","xq","xqmc","xh","xm","xb","xydm","xymc","zydm","zymc","bjdm",
								 "bjmc","nj","cj"};
		expPageData(request, response, tableName, viewName, outputColumn);		
		return mapping.findForward("");
	}
	
	/**
	 * 成绩详细信息查询
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward cjcxOne(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		LsxyPjpyService service = new LsxyPjpyService();
		String viewName = "view_cjb";
		String pkValue = request.getParameter("pkValue");
		String[] outputColumn = {"xn","xq","xh","xm",
								 "bjmc","nj","kcmc","cj","zhxs"};
		
		request.setAttribute("rs", service.queryXscjOne(viewName, outputColumn,pkValue));
		//读写权跟位置信息
		appendOperQx(request, "pjpyLsxy.do?method=cjfcx");
		return mapping.findForward("cjcxOne");
	}
}