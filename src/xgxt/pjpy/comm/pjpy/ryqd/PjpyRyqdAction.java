/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.pjpy.comm.pjpy.ryqd;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.action.Base;
import xgxt.action.BaseAction;
import xgxt.pjpy.comm.pjpy.PjxtszModel;
import xgxt.pjpy.comm.pjpy.jbsz.PjpyJbszService;
import xgxt.pjpy.comm.pjpy.xmsz.PjpyXmszService;
import xgxt.utils.FormModleCommon;
import xgxt.utils.SearchUtils;

/** 
 * MyEclipse Struts
 * Creation date: 02-15-2011
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class PjpyRyqdAction extends BaseAction {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method pjryqd
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward pjryqd(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		PjpyJbszService jbszService = new PjpyJbszService();
		PjpyXmszService xmszService = new PjpyXmszService();
		PjpyRyqdService service =new PjpyRyqdService();
		PjpyRyqdForm myForm=(PjpyRyqdForm)form;
		PjxtszModel jbszModel = PjxtszModel.pjxtszModel;
		HashMap<String, String> jbszMap = jbszService.getPjpyJbsz();
		
		boolean blog=xmszService.getPjXtszb();
		if (!blog) {
			String msg = "评奖基本设置尚未完成，无法进行接下去的操作，请联系管理员或相关人员对其进行设置，请确认！";
			request.setAttribute("yhInfo", msg);
			return new ActionForward("/yhInfo.do", false);
		}
		
		
		String doType=request.getParameter("doType");
		String tableName="xg_pjpy_xsb";
		String viewName="view_xg_pjpy_pjry";
		
		//保存名单
		if("bcmd".equalsIgnoreCase(doType)){
			service.savePjbm(request, myForm);
			//doType="query";
		}
		
		//取消设置(将是否已设置状态位改成否)
		if("qxmdsz".equalsIgnoreCase(doType)){
			HashMap<String, String[]> primaryMap = getValueArrayMap(request,
					PRIFIX_PRIMARY_KEY);
			HashMap<String,String>valueMap=new HashMap<String,String>();
			valueMap.put("sfysz", myForm.getSave_sfysz());
			this.auditingBatchOperation(request, primaryMap, valueMap, tableName);
			//doType="query";
		}
		
		// =============显示============
		if(Base.isNull(request.getParameter("queryequals_pjnd"))){
			myForm.setQueryequals_pjnd(jbszMap.get("pjnd"));
		}
		if(Base.isNull(request.getParameter("queryequals_pjxn"))){
			myForm.setQueryequals_pjxn(jbszMap.get("pjxn"));
		}
		if(Base.isNull(request.getParameter("queryequals_pjxq"))){
			myForm.setQueryequals_pjxq(jbszMap.get("pjxq"));
		}
		// =============显示 end===========
		
		//查询操作
		//if("query".equalsIgnoreCase(doType)){
			myForm.setPjbjdm(request.getParameter("queryequals_pjbjdm"));
			myForm.setPjzydm(request.getParameter("queryequals_pjzydm"));
			myForm.setPjxydm(request.getParameter("queryequals_pjxydm"));
			myForm.setSfysz(request.getParameter("queryequals_sfysz"));
			myForm.setSftz(request.getParameter("queryequals_sftz"));
			myForm.setXydm(request.getParameter("queryequals_xydm"));
			myForm.setZydm(request.getParameter("queryequals_zydm"));
			myForm.setBjdm(request.getParameter("queryequals_bjdm"));
			myForm.setNj(request.getParameter("queryequals_nj"));
			myForm.setPjxn(myForm.getQueryequals_pjxn());
			myForm.setPjxq(myForm.getQueryequals_pjxq());
			myForm.setPjnd(myForm.getQueryequals_pjnd());
			myForm.setXh(request.getParameter("querylike_xh"));
			myForm.setXm(request.getParameter("querylike_xm"));
		
		//}
		
		String []outputColumn={"bgcolor","pkValue","xh","xm","pjnj","pjxymc","pjzymc","pjbjmc","sfysz"};
		List<HashMap<String,String>> topTr = SearchUtils.getTopTr(viewName, outputColumn, null);
		request.setAttribute("clientColumns", "case when sftz='是' then 'green' end bgcolor, ");
		
		ArrayList<String[]> rs = service.getRyqdList(myForm);
		//selectPageDataByPagination(request, form, tableName, viewName, outputColumn);
		//}
		request.setAttribute("topTr", topTr);
		request.setAttribute("rs", rs);
		
		request.setAttribute("pjxn", jbszMap.get("pjxn"));
		request.setAttribute("pjxq", jbszMap.get("pjxq"));
		request.setAttribute("pjnd", jbszMap.get("pjnd"));
		request.setAttribute("pjxqmc", jbszModel.getPjxqmc());
		
		//读写权、表头
		request.setAttribute("path", "pjpy_jbsz_ryqd.do");
		FormModleCommon.commonRequestSet(request);
		//评奖年级、学院、专业、班级
		service.setPjnjxyzybj(request);
		service.setPjNjXyZyBjListForFdyBzr(request);
		FormModleCommon.setNdXnXqList(request);
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);
		return mapping.findForward("pjryqd");
	}

	
	
	/**
	 * 评奖评优-人员初始化
	 * jQuery - ajax 调用
	 */
	public ActionForward pjpyRycsh(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {

		PjpyRyqdService service = new PjpyRyqdService();
		// 同步部门
		boolean result = service.tbbmInfo();
		// 同步学生信息
		result = result ? service.tbxsInfo() : result;
		
		response.setContentType("text/html;charset=gbk"); 
		response.getWriter().print(result); 
		return null;
	}
	
	
	
	
	/** 
	 * Method pjryqd
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward pjztmdsz(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		PjpyJbszService jbszService = new PjpyJbszService();
		PjpyRyqdService service =new PjpyRyqdService();
		PjpyRyqdForm myForm=(PjpyRyqdForm)form;
		// ==============获取评奖基本设置===========
		HashMap<String, String> jbszMap = jbszService.getPjpyJbsz();
		String doType=request.getParameter("doType");
		
		
		//=============显示============
		myForm.setPjnd(jbszMap.get("pjnd"));
		myForm.setPjxn(jbszMap.get("pjxn"));
		myForm.setPjxq(jbszMap.get("pjxq"));
		// =============显示 end===========
		
		//评奖人员整体名单设置
		if("save".equalsIgnoreCase(doType)){
			boolean result=service.plRysz(myForm);
			request.setAttribute("result", result);
		}
		
		//读写权、表头
		request.setAttribute("path", "pjpy_jbsz_ryqd.do");
		FormModleCommon.commonRequestSet(request);
		//评奖年级、学院、专业、班级
		service.setPjnjxyzybj(request);
		request.setAttribute("pjxtszModel", PjxtszModel.pjxtszModel);
		FormModleCommon.setNdXnXqList(request);
		FormModleCommon.setNjXyZyBjList(request);
		return mapping.findForward("pjztmdsz");
	}
}