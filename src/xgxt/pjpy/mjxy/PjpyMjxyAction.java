/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.pjpy.mjxy;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.beanutils.BeanUtils;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.action.Base;
import xgxt.action.BaseAction;
import xgxt.pjpy.PjpyTyForm;
import xgxt.pjpy.zjcm.ZjcmPjpyModel;
import xgxt.pjpy.zjcm.ZjcmPjpyService;
import xgxt.utils.FormModleCommon;

/** 
 * MyEclipse Struts
 * Creation date: 08-19-2010
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class PjpyMjxyAction extends BaseAction {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	/**
	 * 评奖评优_智育分管理
	 * 
	 * @author luojw
	 * @return ActionForward
	 */
	public ActionForward zyfManage(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {

		HttpSession session = request.getSession();
		
		PjpyMjxyForm pjpyMjxyForm = (PjpyMjxyForm) form;
		PjpyMjxyService service = new PjpyMjxyService();
		ZjcmPjpyModel model = new ZjcmPjpyModel();


		String doType = request.getParameter("doType");
		String go=request.getParameter("go");
		String viewName="view_mjxy_zyxxcj";
		String tableName="mjxy_zyxxcj";
		
		String xn = Base.getJxjsqxn();//评奖学年
		String xq = Base.getJxjsqxq();//评奖学期
		
		// 初始化用户权限
		String fdyQx = session.getAttribute("fdyQx").toString();
		String bzrQx = session.getAttribute("bzrQx").toString();
		String userName = session.getAttribute("userName").toString();
		pjpyMjxyForm.setFdyQx(fdyQx);
		pjpyMjxyForm.setBzrQx(bzrQx);
		pjpyMjxyForm.setUserName(userName);
		
		//初始化评奖学年学期
		pjpyMjxyForm.setXn(xn);
		pjpyMjxyForm.setXq(xq);
		pjpyMjxyForm.setQueryequals_xn(xn);
		pjpyMjxyForm.setQueryequals_xq(xq);
		
		//初始化学院(访问者为学院)
		String userType = session.getAttribute("userType").toString();
		String userDep = session.getAttribute("userDep").toString();
		
		if ("xy".equalsIgnoreCase(userType)) {
			pjpyMjxyForm.setXydm(userDep);
		}
		
		BeanUtils.copyProperties(model, pjpyMjxyForm);
		
		// 计算评奖学年学期的智育分
		if ("js".equalsIgnoreCase(doType)) {
			String message =service.runPro();
			request.setAttribute("message", message);
			go="go";
		}
		
		// 点击查询按钮进行查询
		if ((go != null) && "go"
				.equalsIgnoreCase(go)) {
			String[] colList = new String[] { "xn", "xqmc", "xh", "xm", "nj",
					"xymc", "zymc", "bjmc", "zcj" };
			this.selectPageDataByPagination(request, pjpyMjxyForm, tableName, viewName, colList);
		}
		
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);
		FormModleCommon.setNdXnXqList(request);
		request.setAttribute("path", "pjpy_zyf.do");
		FormModleCommon.commonRequestSet(request);
		return mapping.findForward("zyfManage");
	}
	
}