/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.pjpy.ghxy.bjryf;

import java.util.HashMap;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.DispatchAction;

import xgxt.action.Base;
import xgxt.action.BaseAction;
import xgxt.pjpy.nbty.wmbj.NbtyWmbjForm;
import xgxt.pjpy.nbty.wmbj.NbtyWmbjService;
import xgxt.rcsw.kqgl.xskq.RcswKqglXskqService;
import xgxt.szdw.ghxy.njzrwh.GhxyNjzrwhService;
import xgxt.utils.FormModleCommon;
import xgxt.xszz.nbty.jtjjknsbz.NbtyJtjjknsService;

/** 
 * MyEclipse Struts
 * Creation date: 08-05-2010
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class GhxyBjryfAction extends BaseAction {
	/*
	 * Generated Methods
	 */
	protected static final String QUERY ="qry"; //查询页面
	
	protected static final String DELETE = "del";//页面删除操作判断标志
	
	protected static final String VIEW = "view";//页面单个显示详细操作判断标志
	
	protected static final String MODIFY = "modi";//页面修改操作判断标志

	protected static final String SAVE = "save";//页面保存操作判断标志
	
	protected static final String TABNAME = "ghxy_bjryfb";//页面保存操作判断标志
	
	protected static final String VIEWNAME = "view_ghxy_bjryf";//页面保存操作判断标志
	
	/** 
	 * Method BjryWh
	 * 班级荣誉维护
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward bjryfWh(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		HttpSession session=request.getSession();
		GhxyBjryfForm ghxyBjryfForm=(GhxyBjryfForm)form;
		GhxyBjryfService ghxyBjryfService=new GhxyBjryfService();
		
		String userName=session.getAttribute("userName").toString();
		String lx=request.getParameter("lx");
		lx=Base.isNull(lx)? "wh" : lx;
		String pc=request.getParameter("pc");
		String doType=request.getParameter("doType");
		String queryequals_pc = request.getParameter("queryequals_pc");
		String queryequals_xn = request.getParameter("queryequals_xn");
		String queryequals_xq = request.getParameter("queryequals_xq");
		String queryequals_nj = request.getParameter("queryequals_nj");
		String isFdy=session.getAttribute("isFdy").toString();
		queryequals_pc=Base.isNull(queryequals_pc) ? "" : queryequals_pc;
		queryequals_xn=Base.isNull(queryequals_xn) ? "" : queryequals_xn;
		queryequals_nj=Base.isNull(queryequals_nj) ? "" : queryequals_nj;
		//辅导员用户
		
		
		if( MODIFY.equalsIgnoreCase(doType)){
			//批量保存操作
			ghxyBjryfService.plSave(request,ghxyBjryfForm,pc);

		}
		
		//结果集
		request.setAttribute("path", "ghxyBjryf.do?method=bjryfWh");
		FormModleCommon.commonRequestSet(request);
		ghxyBjryfService.ryfPcList(request);
		if("true".equalsIgnoreCase(isFdy)){
			ghxyBjryfService.getBjList(request,ghxyBjryfForm,queryequals_pc,
				queryequals_xn,queryequals_xq,queryequals_nj,userName);
		}
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);						
		FormModleCommon.setNdXnXqList(request);
		request.setAttribute("dqxn", Base.currXn);
		request.setAttribute("dqxq", Base.currXq);
		request.setAttribute("lx", lx);
		return mapping.findForward("bjryfWh");
	}
	
	
	public ActionForward bjryfCx(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		HttpSession session=request.getSession();
		GhxyBjryfService ghxyBjryfService=new GhxyBjryfService();
		GhxyBjryfForm bjryfForm=(GhxyBjryfForm)form;
		GhxyNjzrwhService ghxyNjzrwhService=new GhxyNjzrwhService();
		
		String userType=session.getAttribute("userType").toString();
		String userName=session.getAttribute("userName").toString();
		String doType=request.getParameter("doType");
		String isFdy=session.getAttribute("isFdy").toString();
		//查询操作
		if("stu".equalsIgnoreCase(userType)){
			HashMap<String,String>hashMap=ghxyBjryfService.getXsBjxx(userName);
			bjryfForm.setXydm(hashMap.get("xydm"));
			bjryfForm.setZydm(hashMap.get("zydm"));
			bjryfForm.setBjdm(hashMap.get("bjdm"));
			request.setAttribute("xydm", bjryfForm.getXydm());
			request.setAttribute("zydm", bjryfForm.getZydm());
			request.setAttribute("bjdm", bjryfForm.getBjdm());
		}
		
		if(DELETE.equalsIgnoreCase(doType)){
			this.deleteOperation(request,TABNAME);
			ghxyBjryfService.deleteBjxx();
			doType="qry";
		}
		if(QUERY.equalsIgnoreCase(doType)){
			//批量保存操作
			ghxyBjryfService.getReaders(request, userName,isFdy,userType);
			String []outputColumn={"pkValue","disabled","xn","xqmc","nj","bjmc","zymc","xymc","pcmc","xmmc","xmfz"};
			this.selectPageDataByPagination(request, form, TABNAME, VIEWNAME, outputColumn);
		}
		
		
	
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);	
		
		request.setAttribute("zbList", ghxyBjryfService.zbList());
		request.setAttribute("njfdy", ghxyNjzrwhService.isNjfdy(userName));
		request.setAttribute("path", "ghxyBjryf.do?method=bjryfCx");
		FormModleCommon.commonRequestSet(request);
		ghxyBjryfService.ryfPcList(request);
		FormModleCommon.setNdXnXqList(request);
		if(ghxyNjzrwhService.isNjfdy(userName)){
			request.setAttribute("isNjzr", ghxyNjzrwhService.isNjfdy(userName));
			FormModleCommon.setNjXyZyBjList(request);
			request.setAttribute("njList",ghxyNjzrwhService.getFdyNj(userName));
		}
		return mapping.findForward("bjryfCx");
	}
	
	/**
	 * 班级荣誉分单个增加
	 * method bjryfTj
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward bjryfTj(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		
		HttpSession session=request.getSession();
		String doType=request.getParameter("doType");
		
		GhxyBjryfForm ghxyBjryfForm=(GhxyBjryfForm)form;
		NbtyJtjjknsService nbtyJtjjknsService=new NbtyJtjjknsService();
		GhxyBjryfService service=new GhxyBjryfService();
		service.ryfPcList(request);
		
		//保存操作
		if(SAVE.equalsIgnoreCase(doType)){
			this.insertOperation(request, TABNAME);
		}
		//刷新页面
		if("new".equalsIgnoreCase(doType)){
			String bjdm=request.getParameter("save_plbjdm");
			String xydm=request.getParameter("xydm");
			String zydm=request.getParameter("zydm");
			ghxyBjryfForm.setXydm(xydm);
			ghxyBjryfForm.setZydm(zydm);
			ghxyBjryfForm.setSave_plbjdm(bjdm);
			service.getBjjfxx(request,bjdm);
		}
		
		String xqmc=nbtyJtjjknsService.getXqMc(Base.currXq);
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);		
		
		//指标List
		request.setAttribute("zbList",service.zbList());
		
		request.setAttribute("xqmc", xqmc);
		request.setAttribute("xn", Base.currXn);							
		request.setAttribute("xq", Base.currXq);		
		return mapping.findForward("bjryfTj");
	}
	
	
	/**
	 * 班级荣誉分单个修改
	 * method bjryfTj
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward bjryfXx(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		HttpSession session=request.getSession();
		GhxyBjryfService service=new GhxyBjryfService();
		NbtyJtjjknsService nbtyJtjjknsService=new NbtyJtjjknsService();
		
		String userName=session.getAttribute("userName").toString();
		String userType=session.getAttribute("userType").toString();
		String doType=request.getParameter("doType");
		String pkValue=request.getParameter("pkValue");
		
		if(MODIFY.equalsIgnoreCase(doType)){
			this.updateOperation(request, TABNAME);
		}
		
		this.selectPageDataByOne(request, TABNAME, VIEWNAME, pkValue);
		HashMap<String,String>hashMap=(HashMap<String,String>)request.getAttribute("rs");
		String plbjdm=hashMap.get("plbjdm");
		String pc=hashMap.get("pc");
		String xn=hashMap.get("xn");
		String xq=hashMap.get("xq");
		
		if(service.checkQsryf(userName,userType,plbjdm,pc,xn,xq)){
			request.setAttribute("write", "yes");
		}else{
			request.setAttribute("write", "no");
		}
		//指标List
		request.setAttribute("zbList",service.zbList());
		//批次List
		service.ryfPcList(request);
		
		
		String xqmc=nbtyJtjjknsService.getXqMc(Base.currXq);
		request.setAttribute("pkValue", pkValue);
		request.setAttribute("xqmc", xqmc);		
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);	
		return mapping.findForward("bjryfXx");
	}
	
	
	
	public ActionForward bjryfSz(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		GhxyBjryfService service=new GhxyBjryfService();
		
		String tableName="ghxy_bjryfblsz";
		String doType=request.getParameter("doType");
	
		//查询操作
		if(SAVE.equalsIgnoreCase(doType)){
			this.insertBatchOperation(request, tableName);
			doType="qry";
		}
		
		if("delete".equalsIgnoreCase(doType)){
			this.deleteOperation(request, tableName);
		}
		
		service.ryfdjList(request);
		service.getBlszxx(request);
		
		//结果集
		request.setAttribute("path", "ghxyBjryf.do?method=bjryfSz");
		FormModleCommon.commonRequestSet(request);
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);						
		FormModleCommon.setNdXnXqList(request);
		return mapping.findForward("bjryfSz");
	}
	
	/**
	 * 班级荣誉分审核
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward bjryfSh(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		HttpSession session=request.getSession();
		String doType=request.getParameter("doType");
		GhxyBjryfService service=new GhxyBjryfService();
		GhxyNjzrwhService ghxyNjzrwhService=new GhxyNjzrwhService();
		GhxyBjryfForm ghxyBjryfForm=(GhxyBjryfForm)form;
		NbtyJtjjknsService nbtyJtjjknsService=new NbtyJtjjknsService();
		//保存操作
		String userType=session.getAttribute("userType").toString();
		String userName=session.getAttribute("userName").toString();
		
		String tabName="ghxy_bjryfshb";
		String dj=request.getParameter("dj");
		String viewName="view_ghxy_bjryfsh";
		String shjg=request.getParameter("shjg");
		String pkValue=request.getParameter("pkValue");
		String[]cbv =request.getParameterValues("primarykey_cbv");

		String pc=Base.isNull(request.getParameter("queryequals_pc"))? null : request.getParameter("queryequals_pc");
		
		if(MODIFY.equalsIgnoreCase(doType)){
			
			if(ghxyNjzrwhService.isNjfdy(userName)){
				service.shbSave(request, ghxyBjryfForm, pc);
			}

			
			if(service.checkBjs(userName,dj,cbv.length,pc)){
				HashMap<String, String[]> primaryMap = getValueArrayMap(request, PRIFIX_PRIMARY_KEY);
				HashMap<String,String>valueMap =service.getShxx(userType, userName, shjg,dj);
				this.auditingBatchOperation(request, primaryMap, valueMap, tabName);
				doType="qry";
			}else{
				request.setAttribute("bjbl", "no");
			}
		}
		
		if(QUERY.equalsIgnoreCase(doType)){
			service.getReader(request, userType, userName);
			String[]outputColumn={"pkValue","disabled","plbjdm","xq","xn","xqmc","xymc","zymc","bjmc","pcmc","dxfz","djmc","njzrsh","xxsh"};
			this.selectPageDataByPagination(request, ghxyBjryfForm, tabName, viewName, outputColumn);
		}
		
		
		
		
		//班级荣誉分等级
		service.ryfdjList(request);
		//指标List
		request.setAttribute("zbList",service.zbList());
		//批次List
		service.ryfPcList(request);
		
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);		
		FormModleCommon.setNdXnXqList(request);	
		if(ghxyNjzrwhService.isNjfdy(userName)){
			request.setAttribute("njList",ghxyNjzrwhService.getFdyNj(userName));
		}
		request.setAttribute("isNjbzr",ghxyNjzrwhService.isNjfdy(userName));
		request.setAttribute("path", "ghxyBjryf.do?method=bjryfSh");
		FormModleCommon.commonRequestSet(request);
		String xqmc=nbtyJtjjknsService.getXqMc(Base.currXq);
		request.setAttribute("pkValue", pkValue);
		request.setAttribute("xqmc", xqmc);	
		request.setAttribute("xn", Base.currXn);
		request.setAttribute("xq", Base.currXq);	
		return mapping.findForward("bjryfSh");
	}
	
	/**
	 * bjryfShOne单个审核
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward bjryfShOne(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		
		HttpSession session=request.getSession();
		GhxyBjryfService service=new GhxyBjryfService();
		GhxyNjzrwhService ghxyNjzrwhService=new GhxyNjzrwhService();
		GhxyBjryfForm ghxyBjryfForm=(GhxyBjryfForm)form;
		NbtyJtjjknsService nbtyJtjjknsService=new NbtyJtjjknsService();
	
		String userName=session.getAttribute("userName").toString();
		String doType = request.getParameter("doType");
		String pkValue = request.getParameter("pkValue");
		String djdm=request.getParameter("save_djdm");
	
		
		String tabName="ghxy_bjryfshb";
		String viewName="view_ghxy_bjryfsh";
		String pc=request.getParameter("save_pc");
		String []xnArr={Base.currXn};
		String []xqArr={Base.currXq};
		String [] primarykey={pkValue};
		String [] plbjdm={ghxyBjryfForm.getBjdm()};
		ghxyBjryfForm.setPlbjdm(plbjdm);
		ghxyBjryfForm.setXnArr(xnArr);
		ghxyBjryfForm.setXqArr(xqArr);
		ghxyBjryfForm.setCheckVal(primarykey);
		ghxyBjryfForm.setPrimarykey_cbv(primarykey);
		
		
		//修改操作
		if(MODIFY.equalsIgnoreCase(doType)){
			if(ghxyNjzrwhService.isNjfdy(userName)){
				service.shbSave(request, ghxyBjryfForm, pc);
			}
			if(service.checkBjs(userName,djdm,1,pc)){
			   this.updateOperation(request, tabName);
			}else{
				request.setAttribute("bjbl", "no");
			}
		}
		
		
		//单条记录显示
		this.selectPageDataByOne(request, tabName, viewName, pkValue);
		
		HashMap<String,String>map=(HashMap<String,String>)request.getAttribute("rs");
		
		if(ghxyNjzrwhService.isNjfdy(userName)
				&&"通过".equalsIgnoreCase(map.get("xxsh"))){
			request.setAttribute("write", "no");
		}
		
		if(ghxyNjzrwhService.isNjfdy(userName)){
			ghxyBjryfForm.setSave_njzrsh(map.get("njzrsh"));
		}else{
			ghxyBjryfForm.setSave_xxsh(map.get("xxsh"));
		}
		
		service.getBjjfxx(request,map.get("plbjdm"));
		//荣誉分等级LIST
		service.ryfdjList(request);
		
		String xqmc=nbtyJtjjknsService.getXqMc(Base.currXq);
		request.setAttribute("isNjzr", ghxyNjzrwhService.isNjfdy(userName));
		request.setAttribute("pkValue", pkValue);
		request.setAttribute("xqmc", xqmc);		
		request.setAttribute("pkValue", pkValue);
		request.setAttribute("doType", doType);
		return mapping.findForward("bjryfShOne");
	}
	
	/** 
	 * 报表导出
	 * Method expDate
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	
	public ActionForward expDate(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		try {
			this.expPageData(request, response, TABNAME, VIEWNAME, null);
		} catch (Exception e) {
			e.printStackTrace();
		}			
		
		return mapping.findForward("success");
	}
	
}