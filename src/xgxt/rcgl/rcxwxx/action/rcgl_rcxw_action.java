/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.rcgl.rcxwxx.action;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.util.*;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.action.Base;
import xgxt.rcgl.rcxwxx.form.rcgl_rcxw_from;
import xgxt.xljk.lrh_Util.model.stu_info_model;
import xgxt.xljk.lrh_Util.util.lrh_commen_util;
import xgxt.xljk.lrh_Util.util.stu_info_util;
import xgxt.rcgl.rcxwxx.util.*;

import xgxt.DAO.DAO;
/** 
 * MyEclipse Struts
 * Creation date: 08-06-2007
 * 
 * XDoclet definition:
 * @struts.action path="/rcgl_rcxw" name="rcgl_rcxw_from" scope="request" validate="true"
 */
public class rcgl_rcxw_action extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		
		rcgl_rcxw_from rcgl_rcxw_from = (rcgl_rcxw_from) form;// TODO Auto-generated method stub
		try {
		    int i = Base.chkTimeOut(request.getSession());
		    if (i <= 2) {
		    	rcgl_rcxw_from.setErrMsg("登陆超时，请重新登陆！");
			return new ActionForward("/login.jsp", false);
		    }

		    HttpSession session = request.getSession();
		    if (session == null) {
			request.setAttribute("errMsg", "sadfsdf");
			return mapping.findForward("false");
		    } 
		    ActionForward myActFwd = null;
		    String act = request.getParameter("act");
		    String doType=request.getParameter("doType");
		    String userName=session.getAttribute("userName").toString();
//		    String userDep=session.getAttribute("userDep").toString();
//		    String userNameReal=session.getAttribute("userNameReal").toString();
		    String userType=session.getAttribute("userOnLine").toString();
			boolean isStu = (userType.equalsIgnoreCase("student"));
		  	String writeAble = "" ;
	    	String power = "rcgl_rcxw.do?act=rcxw";
	    	int p = Base.chkUPower(userName, power, isStu);
		if (act.equals("rcxw")) {
			if(doType!=null&&!doType.equalsIgnoreCase(""))
			{
				if(doType.equals("rcxw_add"))
				{
					myActFwd = rcxw_add(mapping,form,request,response);	
				}
				else if(doType.equals("rcxw_search"))
				{	
					myActFwd = rcxw_search(mapping,form,request,response);	
				}
				else if(doType.equals("rcxw_view"))
				{
					myActFwd = rcxw_view(mapping,form,request,response);	
				}
				else if(doType.equals("rcxw_modi"))
				{
					myActFwd = rcxw_modi(mapping,form,request,response);	
				}
				else if(doType.equals("stu_info"))
				{
					myActFwd = stu_info(mapping,form,request,response);	
				}
				else if(doType.equals("rcxw_del"))
				{
					myActFwd = rcxw_del(mapping,form,request,response);	
				}
			}
			else
			{
				myActFwd = index_to_jsp(mapping,form,request,response);	
			}
		}
		writeAble = (p == 1) ? "yes" : "no";
	    request.setAttribute("writeAble", writeAble); 
		return myActFwd;
		}
		catch(Exception e){
			e.printStackTrace();
			rcgl_rcxw_from.setErrMsg("数据连接中断，请重新登陆！");
	    	return new ActionForward("/login.jsp", false);
		}		
	}
	
	 private ActionForward index_to_jsp(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {	
		        DAO dao = DAO.getInstance();
		 		rcgl_rcxw_from myform = (rcgl_rcxw_from)form;
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		myform.deal_gbk();
		 		String xydm=myform.getXydm();
		 		String zydm=myform.getZydm();	 	
		 		List rcxwList=commen_util.get_rcgl_getList("rcgl_rcxw");
				request.setAttribute("rcxwList", rcxwList);
		 		request.setAttribute("xyList", commen_util.get_xyList());
		 		request.setAttribute("bjList", commen_util.get_bjList(xydm, zydm));
		 		request.setAttribute("writeAble", "yes");
		 		request.setAttribute("xnList", dao.getXnndList());// 发送学年列表
	    		request.setAttribute("xqList", dao.getXqList());// 发送学期列表		
		 		return mapping.findForward("index_to_jsp");
	 }
	 private ActionForward stu_info(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		        DAO dao = DAO.getInstance();
		 		rcgl_rcxw_from myform = (rcgl_rcxw_from)form;
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		myform.deal_gbk();
		 		String url="/xgxt/rcgl_rcxw.do?act=rcxw&doType=stu_info";
				String xh=request.getParameter("stu_id");
				if(xh!=null&&!xh.equalsIgnoreCase(""))
				{
					List rcxwList=commen_util.get_rcgl_getList("rcgl_rcxw");
					request.setAttribute("rcxwList", rcxwList);
					myform.setXh(xh);
					stu_info_util stu_info= new stu_info_util();
					stu_info_model stu_mod=new stu_info_model();
					stu_mod=stu_info.stu_find_byxh(xh);
					myform.setXb(stu_mod.getXB());
					myform.setXm(stu_mod.getXM());
					myform.setXydm(stu_mod.getXYDM());
					myform.setXymc(stu_mod.getXYMC());
					myform.setBjdm(stu_mod.getBJDM());
					myform.setBjmc(stu_mod.getBJMC());
			    	request.setAttribute("xnList", dao.getXnndList());// 发送学年列表
			    	request.setAttribute("xqList", dao.getXqList());// 发送学期列表
			    	myform.setXn(dao.getConf(0));//获得系统设置表中当前学年
			    	myform.setXq(dao.getConf(1));//获得系统设置表中当前学期
			    	
					return mapping.findForward("rcxw_add");
				}
				else
				{
					request.setAttribute("url", url);
					return mapping.findForward("stu_info");
				}
	 }
	 
	 private ActionForward rcxw_add(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		        DAO dao = DAO.getInstance(); 
		 		rcgl_rcxw_from myform = (rcgl_rcxw_from)form;
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		rcgl_rcxw_util myutil = new rcgl_rcxw_util();
		 		myutil.rcgl_rcxw_util1(request);
		 		List rcxwList=commen_util.get_rcgl_getList("rcgl_rcxw");
		 		myform.deal_gbk();
		 		String add_flag=request.getParameter("add_flag");
		 		if(add_flag!=null&&!add_flag.equalsIgnoreCase(""))
		 		{
		 			if(add_flag.equals("yes"))
		 			{
		 				String message=myutil.rcxwxx_add(myform);
		 				request.setAttribute("message", message);
		 			}
		 		}		 		
		 		request.setAttribute("xnList", dao.getXnndList());// 发送学年列表
		 		request.setAttribute("xqList", dao.getXqList());// 发送学期列表
		 		myform.setXn(dao.getConf(0));//获得系统设置表中当前学年
		 		myform.setXq(dao.getConf(1));//获得系统设置表中当前学期
		    	
		 		request.setAttribute("rcxwList", rcxwList);
		 		return mapping.findForward("rcxw_add");
	 }
	 
	 private ActionForward rcxw_search(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		 		rcgl_rcxw_from myform = (rcgl_rcxw_from)form;
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		rcgl_rcxw_util myutil = new rcgl_rcxw_util();
		 		myform.deal_gbk();
		 		DAO dao = DAO.getInstance();
		 		String xydm=myform.getXydm();
		 		String zydm=myform.getZydm();
		 		
		 	   
		 		List rs=myutil.rcxwxx_search(myform);
		 		List rcxwList=commen_util.get_rcgl_getList("rcgl_rcxw");
		 		String rsNum=String.valueOf(rs.size());
		 		String []zdm={"XH","XM","XB","MKMC","XYMC","BJMC","JLR","RQ"};
		 		List topTr=commen_util.Get_Table_Title("VIEW_RCGL_RCXWXX", zdm);
	 	    	
	 	    	request.setAttribute("xnList", dao.getXnndList());// 发送学年列表
	 	    	request.setAttribute("xqList", dao.getXqList());// 发送学期列表    
		 		
		 		request.setAttribute("rs",rs);
		 		request.setAttribute("rsNum", rsNum);
		 		request.setAttribute("topTr", topTr);
		 		request.setAttribute("rcxwList", rcxwList);
		 		request.setAttribute("xyList", commen_util.get_xyList());
		 		request.setAttribute("bjList", commen_util.get_bjList(xydm, zydm));
		 		request.setAttribute("writeAble", "yes");
		 		return mapping.findForward("index_to_jsp");
	 }
	 
	 private ActionForward rcxw_view(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		        DAO dao = DAO.getInstance();
		 		rcgl_rcxw_from myform = (rcgl_rcxw_from)form;
		 		rcgl_rcxw_util myutil = new rcgl_rcxw_util();
		 		myform.deal_gbk();
		 		request.setAttribute("is_YNYS", "EXIST");
		 		request.setAttribute("xnList", dao.getXnndList());// 发送学年列表
		 		request.setAttribute("xqList", dao.getXqList());// 发送学期列表
		 		String xn_id=request.getParameter("xn_id");
		 		myform.setRcgl_rcxw_xnid(xn_id);
		 		myform=myutil.rcxwxx_view(myform);
		 		return mapping.findForward("rcxw_view");
	 }
	 
	 private ActionForward rcxw_modi(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		        DAO dao = DAO.getInstance();
		 		rcgl_rcxw_from myform = (rcgl_rcxw_from)form;
		 		rcgl_rcxw_util myutil = new rcgl_rcxw_util();
		 		myutil.rcgl_rcxw_util1(request);
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		myform.deal_gbk();
		 		String xn_id=request.getParameter("xn_id");
		 		myform.setRcgl_rcxw_xnid(xn_id);
		 		String modi_flag=request.getParameter("modi_flag");
		 		List rcxwList=commen_util.get_rcgl_getList("rcgl_rcxw");
		 		if(modi_flag!=null&&!modi_flag.equalsIgnoreCase(""))
		 		{
		 			if(modi_flag.equals("yes"))
		 			{
		 				xn_id=request.getParameter("xn_id");
		 				myform.setRcgl_rcxw_xnid(xn_id);
		 				String message=myutil.rcxwxx_modi(myform);
		 				request.setAttribute("message", message);
		 			}
		 		}
		 		else
		 		{
		 			myform=myutil.rcxwxx_view(myform);
		 		}		 		 
		 		request.setAttribute("xnList", dao.getXnndList());// 发送学年列表
		 		request.setAttribute("xqList", dao.getXqList());// 发送学期列表
		 		request.setAttribute("xn_id", xn_id);
		 		request.setAttribute("rcxwList", rcxwList);
		 		return mapping.findForward("rcxw_modi");
	 }
	 
	 private ActionForward rcxw_del(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		        DAO dao = DAO.getInstance();
		 		rcgl_rcxw_from myform = (rcgl_rcxw_from)form;
		 		rcgl_rcxw_util myutil = new rcgl_rcxw_util();
		 		myutil.rcgl_rcxw_util1(request);
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		myform.deal_gbk();
		 		String xn_id=request.getParameter("xn_id");
		 		myform.setRcgl_rcxw_xnid(xn_id);
		 		String message=myutil.rcxwxx_del(myform);
		 		String xydm=myform.getXydm();
		 		String zydm=myform.getZydm();
		 		List rcxwList=commen_util.get_rcgl_getList("rcgl_rcxw");
		 		request.setAttribute("xnList", dao.getXnndList());// 发送学年列表
	 	    	request.setAttribute("xqList", dao.getXqList());// 发送学期列表    
		 		request.setAttribute("message", message);
				request.setAttribute("rcxwList", rcxwList);
		 		request.setAttribute("xyList", commen_util.get_xyList());
		 		request.setAttribute("bjList", commen_util.get_bjList(xydm, zydm));
		 		request.setAttribute("writeAble", "yes");
		 		return mapping.findForward("index_to_jsp");
	 }
	 
	 
}