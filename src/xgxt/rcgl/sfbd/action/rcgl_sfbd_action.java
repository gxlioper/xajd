/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.rcgl.sfbd.action;

import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.action.Base;
import xgxt.rcgl.sfbd.form.rcgl_sfbd_form;
import xgxt.xljk.lrh_Util.model.stu_info_model;
import xgxt.xljk.lrh_Util.util.lrh_commen_util;
import xgxt.xljk.lrh_Util.util.stu_info_util;
import xgxt.rcgl.sfbd.util.*;

/** 
 * MyEclipse Struts
 * Creation date: 08-07-2007
 * 
 * XDoclet definition:
 * @struts.action path="/rcgl_sfbd" name="rcgl_sfbd_form" scope="request" validate="true"
 */
public class rcgl_sfbd_action extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		rcgl_sfbd_form rcgl_sfbd_form = (rcgl_sfbd_form) form;// TODO Auto-generated method stub
		try {
		    int i = Base.chkTimeOut(request.getSession());
		    if (i <= 2) {
		    	rcgl_sfbd_form.setErrMsg("登陆超时，请重新登陆！");
			return new ActionForward("/login.jsp", false);
		    }

		    HttpSession session = request.getSession();
		    if (session == null) {
			request.setAttribute("errMsg", "sadfsdf");
			return mapping.findForward("false");
		    } 
		    ActionForward myActFwd = null;
		    String act = request.getParameter("act");
		    String doType=request.getParameter("doType");
		    String userName=session.getAttribute("userName").toString();
//		    String userDep=session.getAttribute("userDep").toString();
//		    String userNameReal=session.getAttribute("userNameReal").toString();
		    String userType=session.getAttribute("userOnLine").toString();
			boolean isStu = (userType.equalsIgnoreCase("student"));
		  	String writeAble = "" ;
	    	String power = "rcgl_sfbd.do?act=sfbd";
	    	int p = Base.chkUPower(userName, power, isStu);
		if (act.equals("sfbd")) {
			if(doType!=null&&!doType.equalsIgnoreCase(""))
			{
				if(doType.equals("sfbd_add"))
				{
					myActFwd=sfbd_add(mapping,form,request,response);	
				}
				else if(doType.equals("sfbd_search"))
				{	
					myActFwd=sfbd_search(mapping,form,request,response);	
				}
				else if(doType.equals("sfbd_view"))
				{
					myActFwd=sfbd_view(mapping,form,request,response);	
				}
				else if(doType.equals("sfbd_modi"))
				{
					
				}
				else if(doType.equals("stu_info"))
				{
					myActFwd=stu_info(mapping,form,request,response);	
				}
				else if(doType.equals("sfbd_del"))
				{
					myActFwd=sfbd_del(mapping,form,request,response);	
				}
				else if(doType.equals("sfbd_qrbd"))
				{
					myActFwd=sfbd_qrbd(mapping,form,request,response);	
				}
				//sfbd_qxbd
				else if(doType.equals("sfbd_qxbd"))
				{
					myActFwd=sfbd_qxbd(mapping,form,request,response);	
				}
			}
			else
			{
				myActFwd = index_to_jsp(mapping,form,request,response);	
			}
		}
		writeAble = (p == 1) ? "yes" : "no";
	    request.setAttribute("writeAble", writeAble); 
		return myActFwd;
		}
		catch(Exception e){
			e.printStackTrace();
			rcgl_sfbd_form.setErrMsg("数据连接中断，请重新登陆！");
	    	return new ActionForward("/login.jsp", false);
		}	
	}
	
	 private ActionForward index_to_jsp(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		 		HttpSession session = request.getSession();
		 		String userName=session.getAttribute("userName").toString();
//		 		String userDep=session.getAttribute("userDep").toString();
		 		rcgl_sfbd_form myform = (rcgl_sfbd_form)form;
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		myform.deal_gbk();
		 		boolean writeFlag=commen_util.checkUsrPower(userName);
		 		String xydm=myform.getXydm();
		 		String zydm=myform.getZydm();
		 		List sfbdList=commen_util.get_rcgl_getList("rcgl_bdbj");
		 		List xnList=commen_util.get_rcgl_getList("rcgl_xn");
		 		List xqList=commen_util.get_rcgl_getList("rcgl_xq");
				request.setAttribute("sfbdList", sfbdList);
				request.setAttribute("xnList", xnList);
				request.setAttribute("xqList", xqList);
		 		request.setAttribute("xyList", commen_util.get_xyList());
		 		request.setAttribute("bjList", commen_util.get_bjList(xydm, zydm));
		 		if(writeFlag==false)
		 		{
		 			request.setAttribute("writeAble", "no");
		 		}
		 		else
		 		{
		 			request.setAttribute("writeAble", "yes");
		 		}
		 		return mapping.findForward("index_to_jsp");
	 }
	 private ActionForward sfbd_add(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		 		rcgl_sfbd_form myform = (rcgl_sfbd_form)form;
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		rcgl_sfbd_util  myutil=new rcgl_sfbd_util();
		 		myutil.rcgl_sfbd_util1(request);
		 		myform.deal_gbk();
		 		String add_flag=request.getParameter("add_flag");
		 		if(add_flag!=null&&!add_flag.equalsIgnoreCase(""))
		 		{
		 			if(add_flag.equals("yes"))
		 			{
		 				String xz_flag=request.getParameter("xz_flag");
		 				String message="";
		 				if("xnxq".equals(xz_flag))
		 				{
		 					message=myutil.sfbd_xnxq_add(myform);
		 				}
		 				else if("xs".equals(xz_flag))
		 				{
		 					message=myutil.sfbd_xs_add(myform);
		 				}
		 				request.setAttribute("message", message);
		 			}
		 		}
		 		List sfbdList=commen_util.get_rcgl_getList("rcgl_bdbj");
		 		List xnList=commen_util.get_rcgl_getList("rcgl_xn");
		 		List xqList=commen_util.get_rcgl_getList("rcgl_xq");
				request.setAttribute("sfbdList", sfbdList);
				request.setAttribute("xnList", xnList);
				request.setAttribute("xqList", xqList);
		 		return mapping.findForward("sfbd_add");
	 }
	 
	 private ActionForward stu_info(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		 		rcgl_sfbd_form myform = (rcgl_sfbd_form)form;
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		myform.deal_gbk();
		 		String url="/xgxt/rcgl_sfbd.do?act=sfbd&doType=stu_info";
				String xh=request.getParameter("stu_id");
				if(xh!=null&&!xh.equalsIgnoreCase(""))
				{
					List sfbdList=commen_util.get_rcgl_getList("rcgl_bdbj");
			 		List xnList=commen_util.get_rcgl_getList("rcgl_xn");
			 		List xqList=commen_util.get_rcgl_getList("rcgl_xq");
					request.setAttribute("sfbdList", sfbdList);
					request.setAttribute("xnList", xnList);
					request.setAttribute("xqList", xqList);
					myform.setXh(xh);
					stu_info_util stu_info= new stu_info_util();
					stu_info_model stu_mod=new stu_info_model();
					stu_mod=stu_info.stu_find_byxh(xh);
					myform.setXb(stu_mod.getXB());
					myform.setXm(stu_mod.getXM());
					myform.setXydm(stu_mod.getXYDM());
					myform.setXymc(stu_mod.getXYMC());
					myform.setBjdm(stu_mod.getBJDM());
					myform.setBjmc(stu_mod.getBJMC());
					return mapping.findForward("sfbd_add");
				}
				else
				{
					request.setAttribute("url", url);
					return mapping.findForward("stu_info");
				}
	 }
	 
	 private ActionForward sfbd_search(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		 		HttpSession session = request.getSession();
		 		String userName=session.getAttribute("userName").toString();
//		 		String userDep=session.getAttribute("userDep").toString();
		 		rcgl_sfbd_form myform = (rcgl_sfbd_form)form;
		 		rcgl_sfbd_util  myutil=new rcgl_sfbd_util();
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		myform.deal_gbk();
		 		boolean writeFlag=commen_util.checkUsrPower(userName);
		 		
		 		String xydm=myform.getXydm();
		 		String zydm=myform.getZydm();
		 		
		 		
		 		List rs=myutil.sfbd_search(myform);
		 		String rsNum=String.valueOf(rs.size());
		 		String []zdm={"XH","XM","XB","XYMC","BJMC","XQ","XN","SFBD"};
		 		List topTr=commen_util.Get_Table_Title("VIEW_RCGL_SFBD", zdm);
		 		List sfbdList=commen_util.get_rcgl_getList("rcgl_bdbj");
		 		List xnList=commen_util.get_rcgl_getList("rcgl_xn");
		 		List xqList=commen_util.get_rcgl_getList("rcgl_xq");
		 		
		 		request.setAttribute("rs", rs);
		 		request.setAttribute("rsNum", rsNum);
		 		request.setAttribute("topTr", topTr);
				request.setAttribute("sfbdList", sfbdList);
				request.setAttribute("xnList", xnList);
				request.setAttribute("xqList", xqList);
		 		request.setAttribute("xyList", commen_util.get_xyList());
		 		request.setAttribute("bjList", commen_util.get_bjList(xydm, zydm));
		 		if(writeFlag==false)
		 		{
		 			request.setAttribute("writeAble", "no");
		 		}
		 		else
		 		{
		 			request.setAttribute("writeAble", "yes");
		 		}
		 		return mapping.findForward("index_to_jsp");
	 }
	 
	 private ActionForward sfbd_view(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
//		 		HttpSession session = request.getSession();
//		 		String userName=session.getAttribute("userName").toString();
//		 		String userDep=session.getAttribute("userDep").toString();
		 		rcgl_sfbd_form myform = (rcgl_sfbd_form)form;
		 		rcgl_sfbd_util  myutil=new rcgl_sfbd_util();
		 		myform.deal_gbk();
		 		String xn_id=request.getParameter("xn_id");
		 		myform.setRcgl_sfbd_xnid(xn_id);
		 		myform=myutil.sfbd_view(myform);
		 		return mapping.findForward("sfbd_view");
	 }
	 
	 private ActionForward sfbd_qrbd(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
//		        DAO dao = DAO.getInstance();
		 		HttpSession session = request.getSession();
		 		String userName=session.getAttribute("userName").toString();
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		rcgl_sfbd_form myform = (rcgl_sfbd_form)form;
		 		rcgl_sfbd_util  myutil=new rcgl_sfbd_util();
		 		myutil.rcgl_sfbd_util1(request);
		 		myform.deal_gbk();
		 		String xzstr=request.getParameter("xzstr");
		 		myform.setXzstr(xzstr);
		 		String message=myutil.sfbd_qrbd(myform);
		 		boolean writeFlag=commen_util.checkUsrPower(userName);
		 		String xydm=myform.getXydm();
		 		String zydm=myform.getZydm();
		 		List sfbdList=commen_util.get_rcgl_getList("rcgl_bdbj");
		 		List xnList=commen_util.get_rcgl_getList("rcgl_xn");
		 		List xqList=commen_util.get_rcgl_getList("rcgl_xq");
//		 		List xnList = dao.getXnndList();// 发送学年列表
//		 		List xqList = dao.getXqList();// 发送学期列表
		 	
				request.setAttribute("sfbdList", sfbdList);
				request.setAttribute("xnList", xnList);
				request.setAttribute("xqList", xqList);
		 		request.setAttribute("xyList", commen_util.get_xyList());
		 		request.setAttribute("bjList", commen_util.get_bjList(xydm, zydm));
		 		request.setAttribute("message", message);
		 		if(writeFlag==false)
		 		{
		 			request.setAttribute("writeAble", "no");
		 		}
		 		else
		 		{
		 			request.setAttribute("writeAble", "yes");
		 		}
		 		return mapping.findForward("index_to_jsp");
	 }	 
	 
	 private ActionForward sfbd_qxbd(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		 		HttpSession session = request.getSession();
		 		String userName=session.getAttribute("userName").toString();
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		rcgl_sfbd_form myform = (rcgl_sfbd_form)form;
		 		rcgl_sfbd_util  myutil=new rcgl_sfbd_util();
		 		myutil.rcgl_sfbd_util1(request);
		 		myform.deal_gbk();
		 		String xzstr=request.getParameter("xzstr");
		 		myform.setXzstr(xzstr);
		 		String message=myutil.sfbd_qxbd(myform);
		 		boolean writeFlag=commen_util.checkUsrPower(userName);
		 		String xydm=myform.getXydm();
		 		String zydm=myform.getZydm();
		 		List sfbdList=commen_util.get_rcgl_getList("rcgl_bdbj");
		 		List xnList=commen_util.get_rcgl_getList("rcgl_xn");
		 		List xqList=commen_util.get_rcgl_getList("rcgl_xq");
				request.setAttribute("sfbdList", sfbdList);
				request.setAttribute("xnList", xnList);
				request.setAttribute("xqList", xqList);
		 		request.setAttribute("xyList", commen_util.get_xyList());
		 		request.setAttribute("bjList", commen_util.get_bjList(xydm, zydm));
		 		request.setAttribute("message", message);
		 		if(writeFlag==false)
		 		{
		 			request.setAttribute("writeAble", "no");
		 		}
		 		else
		 		{
		 			request.setAttribute("writeAble", "yes");
		 		}
		 		return mapping.findForward("index_to_jsp");
	 }
	 
	 private ActionForward sfbd_del(ActionMapping mapping, ActionForm form,
	    	    HttpServletRequest request, HttpServletResponse response)
	    	    throws Exception {
		 		HttpSession session = request.getSession();
		 		String userName=session.getAttribute("userName").toString();
		 		lrh_commen_util commen_util= new lrh_commen_util();
		 		rcgl_sfbd_form myform = (rcgl_sfbd_form)form;
		 		rcgl_sfbd_util  myutil=new rcgl_sfbd_util();
		 		myutil.rcgl_sfbd_util1(request);
		 		myform.deal_gbk();
		 		String xzstr=request.getParameter("xzstr");
		 		myform.setXzstr(xzstr);
		 		String message=myutil.sfbd_del(myform);
		 		boolean writeFlag=commen_util.checkUsrPower(userName);
		 		String xydm=myform.getXydm();
		 		String zydm=myform.getZydm();
		 		List sfbdList=commen_util.get_rcgl_getList("rcgl_bdbj");
		 		List xnList=commen_util.get_rcgl_getList("rcgl_xn");
		 		List xqList=commen_util.get_rcgl_getList("rcgl_xq");
				request.setAttribute("sfbdList", sfbdList);
				request.setAttribute("xnList", xnList);
				request.setAttribute("xqList", xqList);
		 		request.setAttribute("xyList", commen_util.get_xyList());
		 		request.setAttribute("bjList", commen_util.get_bjList(xydm, zydm));
		 		request.setAttribute("message", message);
		 		if(writeFlag==false)
		 		{
		 			request.setAttribute("writeAble", "no");
		 		}
		 		else
		 		{
		 			request.setAttribute("writeAble", "yes");
		 		}
		 		return mapping.findForward("index_to_jsp");
	 }
	 
}