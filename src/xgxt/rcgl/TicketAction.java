/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.rcgl;

import java.util.HashMap;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.DispatchAction;

import xgxt.DAO.DAO;
import xgxt.action.Base;
import xgxt.base.DealString;
import xgxt.daoActionLogic.StandardOperation;
import xgxt.form.CommanForm;


public class TicketAction extends DispatchAction {
	
	DAO dao = DAO.getInstance();	
	
	/**
	 * 保存操作成功信息
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception
	 * */
	public ActionForward SaveSucessMessage(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
			// TODO Auto-generated method stub
			boolean flag = false;
			String message = DealString.toGBK(request.getParameter("val"));
			String gnmkdm = "N150903";
			String doType = request.getParameter("doType");
			String tableName = "mktsxxb";
			HashMap< String, String> rs = new HashMap<String, String>();
			
			if("save".equalsIgnoreCase(doType))
			{
				message = message==null? "" :message;
				String mkStr = dao.getOneRs("select gnmkdm from "+tableName +" where gnmkdm=?",new String[]{gnmkdm} , "gnmkdm");
				if(mkStr.length()>0){
					flag = StandardOperation.update(tableName, new String[] {"tsxx"}, new String[]{message}, "gnmkdm", gnmkdm, request);
				}else{
					flag = StandardOperation.insert(tableName, new String[] {"gnmkdm","tsxx"},new String[]{gnmkdm,message}, request);
				}
				request.setAttribute("result", flag);
			} 
			
			rs = dao.getMap("select tsxx from "+tableName+" where gnmkdm=?", new String[] {gnmkdm}, new String [] {"tsxx"});
			request.setAttribute("rs", rs);			
		return mapping.findForward("success");
	}
	
	/**
	 * 删除车票预定信息
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception
	 */
	public ActionForward delCpydInfo(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		CommanForm tick = (CommanForm)form;
		boolean flag = false;
		String doType = request.getParameter("doType");
		StringBuffer sb = new StringBuffer(" where 1=1 ");
		String sql = "";
		String xn = tick.getXn();
		String nd = tick.getNd();
		String xq = tick.getXq();
		if(xn!=null ||!"".equalsIgnoreCase(xn)){
			sb.append(" and xn='" + xn + "'");
		}
		if(nd!=null ||!"".equalsIgnoreCase(nd)){
			sb.append(" and nd='" + nd + "'");
		}
		if(xq!=null ||!"".equalsIgnoreCase(xq)){
			sb.append(" and xq='" + xq + "'");
		}
		if(doType!=null && doType.equalsIgnoreCase("del")){
			sql = "delete from cpydb " + sb.toString();
			flag = StandardOperation.delete(sql, "cpydb", request);
			request.setAttribute("result", flag);
		}
		request.setAttribute("xnndList", Base.getXnndList());
		request.setAttribute("xqList", Base.getXqList());
		return new ActionForward("/sjcz/stu_ticket_del.jsp",false);
	}
	
	/**
	 * 删除车票预定信息
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward delCc(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception{
		String tableName = "hcccb";
		TicketService service = new TicketService();
		
		request.setAttribute("tableName", request.getParameter("tableName"));
		request.setAttribute("realTable", request.getParameter("realTable"));
		request.setAttribute("act", request.getParameter("act"));
		request.setAttribute("pk", request.getParameter("pk"));
		request.setAttribute("result", service.deleteAllInfo(tableName, request));
		return new ActionForward("/train_time_search.do?act=trainTime",false);
	}
}