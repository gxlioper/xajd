/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.qgzx.action;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.beanutils.BeanUtils;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.action.Base;
import xgxt.base.Excel2Oracle;
import xgxt.daoActionLogic.StandardOperation;
import xgxt.form.CommanForm;
import xgxt.form.User;
import xgxt.qgzx.form.QgzxForm;
import xgxt.qgzx.service.QgzxCjffglService;
import xgxt.qgzx.service.QgzxService;
import xgxt.qgzx.zgdzdx.QgzxCjffService;
import xgxt.studentInfo.service.StudentInfoService;
import xgxt.utils.FormModleCommon;
import xgxt.utils.GetTime;
import xgxt.utils.String.StringUtils;

import com.zfsoft.basic.BasicAction;
import common.Globals;

public class QgzxCjffglAction extends BasicAction {
	/***
	 * 加载页面参数
	 * @param request
	 * @param xydm
	 * @param zydm
	 * @param nj
	 * @return void
	 * */
	public void appendProperties(HttpServletRequest request, String xydm,
			String zydm, String nj) throws Exception {
		QgzxService service = new QgzxService();
		String xy = "";
		String zy = "";
		String njLocal = nj;
		xy = xy==null ? "": (xydm==null ? "" : xydm); 
		zy = zy==null ? "": (zydm==null ? "" : zydm); 
		njLocal = nj==null ? "": nj;
		String zyKey = xy==null ? "":xy; 
		String bjKey = xy+"!!"+zy+"!!"+njLocal;
		String userType = request.getSession().getAttribute("userType").toString();
		
		request.setAttribute("writeAble", "yes");//判断用户读写权
		request.setAttribute("xqList", Base.getXqList());//学期列表
		request.setAttribute("xnList", Base.getXnndList());//学年列表
		request.setAttribute("ndList", Base.getXnndList());//学年列表
		request.setAttribute("njList", Base.getNjList());//年级列表
		request.setAttribute("xyList", Base.getXyList());//学院列表
		request.setAttribute("zyList", Base.getZyMap().get(zyKey));//专业列表
		request.setAttribute("bjList", Base.getBjMap().get(bjKey));//班级列表
		request.setAttribute("yfList", service.getYfList());
		request.setAttribute("rqList", service.getRqList());
		request.setAttribute("userType", userType);//用户类型		
	}
	
	/**
	 * 酬金发放信息
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward cjff(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{
		HttpSession session = request.getSession();
		QgzxForm model = (QgzxForm) form;
		QgzxService qgzxService = new QgzxService();
		StringBuilder annexTerm = new StringBuilder();
		HashMap<String, String> confMap = qgzxService.getSqsjInfo();
		
		String userName = session.getAttribute("userName").toString();
		String userType = session.getAttribute("userType").toString();
		String userDep = session.getAttribute("userDep").toString();
		String xxdm = StandardOperation.getXxdm();
		
		if(StringUtils.isNotNull(request.getParameter("go"))){//数据查询
			String[] outputColumn = {"pkValue", "nd", "xn", "xueqimc", "gwdm", "yrdwmc",
					                 "gwxzmc", "xyrs", "spbcbz", "sqsyrs"};
			if(xxdm.equalsIgnoreCase(Globals.XXDM_BJLHDX)){
				//北京联合
				outputColumn = new String[] { "pkValue", "nd", "xn", "xueqimc","gwdm",
					"yrdwmc", "gwxzmc", "xyrs", "spbcbz","tmpsqsyrs","xymc" };
			}
			
			annexTerm.append(" and shjg='通过'");
			if(qgzxService.isYrdwUser(userName) && !"admin".equalsIgnoreCase(userType)){//用人单位只能查询到自己的岗位
				annexTerm.append(" and exists (select yrdwdm from yrdwdmb b where a.sqdw=b.yrdwdm and b.dlm='");
				annexTerm.append(userName);
				annexTerm.append("')");
			}
			// ------2010/5/17 edit by luojw -----------
			// 广州大学
			if (Globals.XXDM_GZDX.equalsIgnoreCase(xxdm)) {
				if ("xy".equalsIgnoreCase(userType) || "stu".equalsIgnoreCase(userType)) {
					annexTerm.append(" and exists (select 1 from qgzx_xyrsb b where a.gwdm = b.gwdm and a.gwsbsj = b.gwsbsj and b.xydm = '");
					annexTerm.append(userDep);
					annexTerm.append("'  and b.fprs is not null and b.fprs > 0)");
				}
			}
			// ------end-----------
			request.setAttribute("annexTerm", annexTerm);			
			this.selectPageDataByPagination(request, model, "gwxxb", "view_gwxx", outputColumn);
		}else{			
			model.setQueryequals_xn(confMap.get("xn"));
			model.setQueryequals_nd(confMap.get("nd"));
			model.setQueryequals_xueqi(confMap.get("xq"));
		}
		
		HashMap<String, String> paramter = new HashMap<String, String>();
		paramter.put("userName", userName);
		paramter.put("xn", model.getQueryequals_xn());
		paramter.put("nd", model.getQueryequals_nd());
		paramter.put("xq", model.getQueryequals_xueqi());
		
		request.setAttribute("gwxzList", qgzxService.getGwxzCjList());
		request.setAttribute("gwList",qgzxService.getGwmcxxList(paramter,"no"));//所有审核通过岗位列表
		request.setAttribute("xnList", Base.getXnndList());//学年列表
		request.setAttribute("ndList", Base.getXnndList());//年度列表
		request.setAttribute("xqList", Base.getXqList());//学期列表
		request.setAttribute("writeAble", "yes");
		request.setAttribute("conf", confMap);
		request.setAttribute("day", GetTime.getNowDay());
		return mapping.findForward("cjff");
	}
	
	/**
	 * 显示填写详单信息页面
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward txxd(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{
		QgzxCjffglService service = new QgzxCjffglService();
		QgzxService qgzxService = new QgzxService();
		String pkValue = request.getParameter("pkValue");
		String xxdm = StandardOperation.getXxdm();
		
		this.selectPageDataByOne(request, "gwxxb", "view_gwxx", pkValue);
		
		HashMap<String, String> map = (HashMap<String, String>) request.getAttribute("rs");	//岗位相关信息	
		map.putAll(qgzxService.getSqsjInfo());//put参数设置信息
		map.put("yf", map.get("cjffsj").substring(4,6));//酬金发放月份
		map.put("nd", map.get("cjffsj").substring(0,4));//酬金发放年度
		map.put("xxdm", xxdm);
		if(Globals.XXDM_BJLHDX.equalsIgnoreCase(xxdm)){
			//北京联合大学
			map.put("jybcbz", map.get("mxsbc"));
		}		
		map.putAll(service.querySyjf(map));//put剩余经费信息
		
		List<HashMap<String, String>> ffList = service.queryXscjff(pkValue,map);//查询学生酬金方法信息
		request.setAttribute("workInfo", map);
		request.setAttribute("ffList", ffList);
		request.setAttribute("count", ffList.size());
		if(Globals.XXDM_ZJJDZYJSXY.equalsIgnoreCase(xxdm)){
			//浙江机电
			request.setAttribute("cjffY",map.get("nd"));
			request.setAttribute("cjffM",map.get("yf"));
		}		
		return mapping.findForward("cjff_txxd");
	}
	
	/**
	 * 导出学生酬金发放信息
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward expXscjffxx(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{		
		HttpSession session = request.getSession();
		QgzxForm model = (QgzxForm) form;
		QgzxService service = new QgzxService();
		QgzxCjffglService cjffService = new QgzxCjffglService();
		List<String[]> list = new ArrayList<String[]>();
		String userName = session.getAttribute("userName").toString();
		String xxdm = StandardOperation.getXxdm();
		
		FormModleCommon.formToGBK(model);
		model.setUserName(userName);
		String[] colList = {"xh","xm","xb","nj","xydm","xymc","zydm","zymc",
				            "bjdm","bjmc","xn","nd","xq","xqmc","yf","gwdm",
				            "gwxzmc","sqdw","yrdwmc","cjje","ffsj","gzsj",
				            "sqsj","bz"};
		String[] colListCN = service.getColumnNameCN(colList, "view_xscjff");
		
		if(Globals.XXDM_ZGDZDX.equalsIgnoreCase(xxdm)){
			//中国地质大学		
			if("临时岗工资".equalsIgnoreCase(model.getFflx())){
				colList = new String[]{"xh","xm","xb","nj","xydm","xymc","zydm",
									   "zymc","bjdm","bjmc","xn","nd","xq","xqmc",
									   "yf","gwdm","gwxzmc","sqdw","yrdwmc","cjje",
									   "ffsj","gzsj","gwsbsj","bz"};
			}
			list = cjffService.queryZgdzdxXscjffForExport(model,colList);
		}else{
			list = cjffService.queryXscjffForExport(model,colList);
		}
		
		response.reset();
		response.setContentType("application/vnd.ms-excel");		
		Excel2Oracle.exportData(list,colList,colListCN, response.getOutputStream());
		return mapping.findForward("");
	}
	
	/**
	 * 显示增加学生酬金发放信息页面
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward addXscjff(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response){
		QgzxService service = new QgzxService();
		StudentInfoService stuinfo = new StudentInfoService();
		QgzxForm model = (QgzxForm) form;
		CommanForm commanForm = new CommanForm();
		model.setXh(request.getParameter("xh"));
		//查询学生的基本信息显示到增加页面
		request.setAttribute("rs", stuinfo.getStuInfo(model.getXh()));
		//查询参数设置信息
		request.setAttribute("config", service.getSqsjInfo());
		
		//将学号拷贝到CommanForm中查询学生所在的岗位列表
		commanForm.setXh(model.getXh());
		request.setAttribute("ndList", Base.getXnndList());
		request.setAttribute("yfList", service.getYfList());
		request.setAttribute("gwList", service.getStuGwList(commanForm));
		return mapping.findForward("addXscjff");
	}
	
	/**
	 * 保存学生酬金发放信息
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward xscjffAdd(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{
		QgzxForm model = (QgzxForm) form;
		QgzxCjffglService service = new QgzxCjffglService();
		QgzxService qgzx = new QgzxService();
		
		//modl中的gwdm包含的值是 gwdm||'-'||gwsbsj
		String xmdm = model.getGwdm();
		String gwdm = xmdm.split("-")[0];
		String gwsbsj = xmdm.split("-")[1];
		
		model.setGwdm(gwdm);
		model.setGwsbsj(gwsbsj);
		
		//将学号拷贝到CommanForm中查询学生所在的岗位列表
		CommanForm commanForm = new CommanForm();
		commanForm.setXh(model.getXh());
		
		request.setAttribute("result", service.saveXscjff(model,request));
		request.setAttribute("ndList", Base.getXnndList());
		request.setAttribute("yfList", qgzx.getYfList());
		request.setAttribute("gwList", qgzx.getStuGwList(commanForm));
		request.setAttribute("rs", model);
		return mapping.findForward("addXscjff");
	}
	
	/**
	 * 显示批量修改学生酬金发放信息页面
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * */
	public ActionForward batchModiXscjff(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{
		QgzxService qgzx = new QgzxService();
		
		request.setAttribute("config", qgzx.getSqsjInfo());//参数设置信息
		//页面选择的数据主键值连接成字符串发送到页面
		request.setAttribute("pkV",request.getParameter("pkV"));
		request.setAttribute("ndList",Base.getXnndList());
		request.setAttribute("yfList", qgzx.getYfList());
		return mapping.findForward("batchModiXscjff");
	}
	
	/**
	 * 批量修改学生酬金发放信息
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward modiXscjffBatch(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{
		String pkV = request.getParameter("pkV");
		QgzxForm model = (QgzxForm)form;
		QgzxService qgzx = new QgzxService();
		QgzxCjffglService service = new QgzxCjffglService();
		
		model.setPkV(pkV.split("!!"));
		request.setAttribute("result", service.modiXscjffBatch(model,request));
		request.setAttribute("pkV",pkV);
		request.setAttribute("ndList",Base.getXnndList());
		request.setAttribute("yfList", qgzx.getYfList());
		request.setAttribute("config", qgzx.getSqsjInfo());//参数设置信息
		return mapping.findForward("batchModiXscjff");
	}
	
	/**
	 * 浙江传媒学院酬金发放审核查询
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward cjffAudiSearch(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{
		QgzxForm model = (QgzxForm) form;
		QgzxService qgzx = new QgzxService();
		QgzxCjffService service = new QgzxCjffService();
		
		String userName = request.getSession().getAttribute("userName").toString();
		String goFlag = request.getParameter("go");
		
		if(StringUtils.isNotNull(goFlag)){//查询操作
			CommanForm comman = new CommanForm();
			BeanUtils.copyProperties(comman, model);
			comman.setTableName("view_xscjff");
			comman.setUserName(request.getSession().getAttribute("userName").toString());
			
			List<String[]> rs = service.queryXscjffb(comman);
			
			BeanUtils.copyProperties(model, comman);
			request.setAttribute("rs", rs);
			request.setAttribute("rsNum", rs.size());
			request.setAttribute("topTr", service.getXscjffTorTr(comman));
		}
		
		
		request.setAttribute("gwList", qgzx.getGwmcList(userName));//岗位列表
		request.setAttribute("yrdwList", qgzx.getYrdwList(userName));//用人单位列表
		appendProperties(request, model.getXydm(), model.getZydm(), model.getNj());
		return mapping.findForward("cjffAudiSearch");
	}
	
	/**
	 * 浙江传媒学院酬金发放批量审核
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward xscjffAudiBatch(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response){
		QgzxForm model  = (QgzxForm) form;
		QgzxCjffglService service = new QgzxCjffglService();
		model.setShjg(request.getParameter("shjg"));
		
		request.setAttribute("result", service.xscjffAudiBatch(model));
		return new ActionForward("/qgzxcjff.do?method=cjffAudiSearch&go=go");
	}
	
	/**
	 * 浙江传媒学院显示酬金发放单个审核页面
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward showXscjffsh(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response){
		String pkV = request.getParameter("pkV");
		QgzxCjffglService service = new QgzxCjffglService();
		
		request.setAttribute("pkV", pkV);
		request.setAttribute("rs", service.queryXscjffOne(pkV));//查询单条酬金发放信息
		return mapping.findForward("xscjffAudi");		
	}
	
	/**
	 * 浙江传媒学院酬金发放单个审核
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward xscjffAudiOne(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{
		QgzxForm model = (QgzxForm) form;
		String pkV = request.getParameter("pkV");
		String shjg = request.getParameter("xxsh");
		QgzxCjffglService service = new QgzxCjffglService();
		
		model.setPkValue(pkV);
		model.setShjg(shjg);
		request.setAttribute("result", service.xscjffAudiOne(model,request));
		return new ActionForward("/qgzxcjff.do?method=showXscjffsh&pkV=" + pkV);
	}
	
	/**
	 * 勤工助学酬金发放汇总表打印
	 * @param ActionMapping mapping
	 * @param ActionForm form
	 * @param HttpServletRequest request
	 * @param HttpServletResponse response
	 * @return ActionForward
	 * @throws Exception 
	 * */
	public ActionForward printCjffhzb(ActionMapping mapping, ActionForm form,HttpServletRequest request,
			HttpServletResponse response) throws Exception{
		QgzxForm model = (QgzxForm) form;
		User user = getUser(request);
		QgzxCjffglService service = new QgzxCjffglService();
		response.reset();
		response.setContentType("application/vnd.ms-excel");
		
		service.printCjffhzb(model,user,response.getOutputStream());
		return new ActionForward("");
	}
	
	
	
	/**
	 * 武汉铁路职业技术学院-工资签发表<br>
	 * <strong>个性化</strong>
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward gzqfb(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		
		QgzxForm model = (QgzxForm) form;
		User user = getUser(request);
		QgzxCjffglService service = new QgzxCjffglService();
		response.reset();
		response.setContentType("application/vnd.ms-excel");
		
		service.printGzqfb(model,response.getOutputStream());
		
		return mapping.findForward("");
	}
	
}