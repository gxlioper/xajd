/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.qgzx.action;

import java.util.HashMap;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.form.User;
import xgxt.qgzx.form.QgzxGwfbForm;
import xgxt.qgzx.service.QgzxGwfbService;
import xgxt.qgzx.service.QgzxService;
import xgxt.utils.FormModleCommon;
import xgxt.utils.String.StringUtils;

import com.zfsoft.basic.BasicAction;

/**
 * <p>Title: 学生工作管理系统</p>
 * <p>Description: 勤工助学岗位发布管理Action</p>
 * <p>Copyright: Copyright (c) 2008</p>
 * <p>Company: zfsoft</p>
 * <p>Author: 李容</p>
 * <p>Version: 1.0</p>
 * <p>Time: 2010-12-07</p>
 */
public class QgzxGwfbglAction extends BasicAction {
	
	/** 
	 * 岗位发布
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward gwfb(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		User user = getUser(request);
		QgzxGwfbForm model = (QgzxGwfbForm)form;
		QgzxService service = new QgzxService();
		QgzxGwfbService qgsService = new QgzxGwfbService();
		
		HashMap<String, String> conf = service.getSqsjInfo();
		HashMap<String, String> rs = new HashMap<String, String>();
		String act = request.getParameter("act");//操作
		String pkValue = request.getParameter("pkValue");//主键值
		String tableName = "view_gwxx";//视图名
		String realTable = "gwxxb";//表名
		
		if("stu".equalsIgnoreCase(user.getUserType())){
			request.setAttribute("errMsg", "该功能对学生用户不开放！");
			return new ActionForward("/errMsg.do",false);
		}
		if("save".equalsIgnoreCase(act)){//信息保存
			if(StringUtils.isNotNull(pkValue)){
				updateOperation(request, realTable);
			}else{
				this.insertOperation(request, realTable);//保存岗位信息
				//获取主键
				String gwsbsj = qgsService.getZjgwsbsj(model.getSave_gwdm());
				pkValue = model.getSave_gwdm()+gwsbsj;
			}
		}
		selectPageDataByOne(request, realTable, tableName, pkValue);//查询单个岗位信息
		rs = (HashMap<String, String>) request.getAttribute("rs");
		rs = rs==null ? new HashMap<String, String>() : rs;
		//默认时间为参数设置中的时间
		if(StringUtils.isNull(rs.get("save_xn"))){
			rs.put("save_xn", conf.get("xn"));
		}
		if(StringUtils.isNull(rs.get("save_nd"))){
			rs.put("save_nd", conf.get("nd"));
		}
		if(StringUtils.isNull(rs.get("save_xq"))){
			rs.put("save_xueqi", conf.get("xq"));
		}
		if(StringUtils.isNull(rs.get("save_xqmc"))){
			rs.put("save_xqmc", conf.get("xqmc"));
		}
		
		request.setAttribute("rs", rs); 
		request.setAttribute("path", "qgzxgwfb.do");//菜单路径
		FormModleCommon.commonRequestSet(request);//读写权信息
		//页面下拉列表数据的加载
		initGwfbSelectData(request);
		//加载参数设置信息
		request.setAttribute("conf", conf);
		request.setAttribute("doType", request.getParameter("doType"));
		return mapping.findForward("gwfb");
	}	
	
	/** 
	 * 校外岗位发布
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward xwgwfb(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		QgzxGwfbForm model = (QgzxGwfbForm)form;
		QgzxService service = new QgzxService();
		QgzxGwfbService qgsService = new QgzxGwfbService();
		
		HashMap<String, String> conf = service.getSqsjInfo();
		HashMap<String, String> rs = new HashMap<String, String>();
		String act = request.getParameter("act");//操作
		String pkValue = request.getParameter("pkValue");//主键值
		String tableName = "view_gwxx";//视图名
		String realTable = "gwxxb";//表名
		
		if("save".equalsIgnoreCase(act)){//信息保存
			if(StringUtils.isNotNull(pkValue)){
				updateOperation(request, realTable);				
			}else{
				this.insertOperation(request, realTable);//保存岗位信息
				//获取主键
				String gwsbsj = qgsService.getZjgwsbsj(model.getSave_gwdm());
				pkValue = model.getSave_gwdm()+gwsbsj;
			}
		}
		selectPageDataByOne(request, realTable, tableName, pkValue);//查询单个岗位信息
		rs = (HashMap<String, String>) request.getAttribute("rs");
		rs = rs==null ? new HashMap<String, String>() : rs;
		//默认时间为参数设置中的时间
		if(StringUtils.isNull(rs.get("save_xn"))){
			rs.put("save_xn", conf.get("xn"));
		}
		if(StringUtils.isNull(rs.get("save_nd"))){
			rs.put("save_nd", conf.get("nd"));
		}
		if(StringUtils.isNull(rs.get("save_xq"))){
			rs.put("save_xueqi", conf.get("xq"));
		}
		if(StringUtils.isNull(rs.get("save_xqmc"))){
			rs.put("save_xqmc", conf.get("xqmc"));
		}
		
		request.setAttribute("rs", rs); 
		request.setAttribute("path", "qgzxgwfb.do");//菜单路径
		FormModleCommon.commonRequestSet(request);//读写权信息
		request.setAttribute("path", "gwfb.do?method=xwgwfb");//时间路径
		//页面下拉列表数据的加载
		initGwfbSelectData(request);
		//加载参数设置信息
		request.setAttribute("conf", conf);
		request.setAttribute("doType", request.getParameter("doType"));
		return mapping.findForward("xwgwfb");
	}
	
	/** 
	 * 岗位发布修改
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward gwfbModi(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		User user = getUser(request);
		QgzxService service = new QgzxService();
		String page = "gwfb";
		
		HashMap<String, String> conf = service.getSqsjInfo();
		HashMap<String, String> rs = new HashMap<String, String>();
		String doType = request.getParameter("doType");//操作类型
		String pkValue = request.getParameter("pkValue");//主键值
		String tableName = "view_gwxx";//视图名
		String realTable = "gwxxb";//表名
		
		//学生用户不能访问
		if("stu".equalsIgnoreCase(user.getUserType())){
			request.setAttribute("errMsg", "该功能对学生用户不开放！");
			return new ActionForward("/errMsg.do",false);
		}
		
		if("save".equalsIgnoreCase(doType)){//信息保存
			this.updateOperation(request, realTable);//保存岗位信息
		}
		selectPageDataByOne(request, realTable, tableName, pkValue);//查询单个岗位信息
		rs = (HashMap<String, String>) request.getAttribute("rs");
		rs = rs==null ? new HashMap<String, String>() : rs;
		
		request.setAttribute("rs", rs);
		request.setAttribute("path", "qgzxgwfb.do");//菜单路径
		FormModleCommon.commonRequestSet(request);//读写权信息
		if("xwgw".equalsIgnoreCase(rs.get("gwflag"))){
			page = "xwgwfb";
		}
		//页面下拉列表数据的加载
		initGwfbSelectData(request);
		//加载参数设置信息
		request.setAttribute("conf", conf);
		request.setAttribute("pkValue", pkValue);
		request.setAttribute("doType", "modi");
		return mapping.findForward(page);
	}
	
	/** 
	 * 岗位发布详细
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward gwfbDetails(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		QgzxService service = new QgzxService();
		String page = "gwxx";
		
		HashMap<String, String> rs = new HashMap<String, String>();
		String pkValue = request.getParameter("pkValue");//主键值
		String tableName = "view_gwxx";//视图名
		String realTable = "gwxxb";//表名
		
		selectPageDataByOne(request, realTable, tableName, pkValue);//查询单个岗位信息
		rs = (HashMap<String, String>) request.getAttribute("rs");
		rs = rs==null ? new HashMap<String, String>() : rs;
		
		request.setAttribute("rs", rs); 
		request.setAttribute("path", "qgzxgwfb.do");//菜单路径
		FormModleCommon.commonRequestSet(request);//读写权信息		
		if("xwgw".equalsIgnoreCase(rs.get("gwflag"))){//跳转位置
			page = "xwgwxx";
		}
		//页面下拉列表数据的加载
		initGwfbSelectData(request);
		//加载岗位下的学生信息
		request.setAttribute("xsList", service.getCjgwxsList("gwdm||gwsbsj",pkValue));//参加岗位的学生列表
		return mapping.findForward(page);
	}
	
	/** 
	 * 岗位发布审核
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward gwfbsh(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		QgzxService service = new QgzxService();
		String page = "gwfbsh";
		
		HashMap<String, String> rs = new HashMap<String, String>();
		String act = request.getParameter("act");//操作类型
		String pkValue = request.getParameter("pkValue");//主键值
		String tableName = "view_gwxx";//视图名
		String realTable = "gwxxb";//表名
		
		if("save".equalsIgnoreCase(act)){//信息保存
			this.updateOperation(request, realTable);//保存岗位信息			
		}
		selectPageDataByOne(request, realTable, tableName, pkValue);//查询单个岗位信息
		rs = (HashMap<String, String>) request.getAttribute("rs");
		rs = rs==null ? new HashMap<String, String>() : rs;
		
		request.setAttribute("rs", rs);
		request.setAttribute("path", "post_check.do");//菜单路径
		
		FormModleCommon.commonRequestSet(request);//读写权信息
		if("xwgw".equalsIgnoreCase(rs.get("gwflag"))){//跳转位置
			page = "xwgwfbsh";
		}
		//页面下拉列表数据的加载
		initGwfbSelectData(request);
		//审核列表
		request.setAttribute("chkList", service.getChkList(3));
		request.setAttribute("pkValue", pkValue);
		request.setAttribute("doType", "modi");
		return mapping.findForward(page);
	}
	
	
	/**
	 * 初始化岗位发布页面下拉列表数据
	 * @param request
	 * */
	public void initGwfbSelectData(HttpServletRequest request){
		User user = getUser(request);
		QgzxGwfbService service = new QgzxGwfbService();		
		//校区
		request.setAttribute("xiaoquList", service.getSelectData("xiaoqu"));
		//岗位性质
		request.setAttribute("gwxzList", service.getSelectData("gwxz"));
		//申请单位
		request.setAttribute("yrdwList", service.getYrdwList(user));
		//计酬方式
		request.setAttribute("jcfsList", service.getSelectData("jcfs"));
	}
}