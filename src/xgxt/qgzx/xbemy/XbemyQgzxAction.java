/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.qgzx.xbemy;

import java.util.HashMap;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.DispatchAction;

import xgxt.DAO.DAO;
import xgxt.base.DealString;
import xgxt.daoActionLogic.StandardOperation;

/** 
 * MyEclipse Struts
 * Creation date: 05-05-2008
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class XbemyQgzxAction extends DispatchAction {
	
	/**
	 * 查询公用方法
	 * */
	public void baseQueryAction(ActionForm form,HttpServletRequest request){
		XbemyQgzxDAO xbDao = new XbemyQgzxDAO();
		DAO dao = DAO.getInstance();
		List rs = null;
		List topTr = null;
		int rsNum = 0;
		String[] input = null;
		
		String tableName = request.getParameter("tabName");
		String go = request.getParameter("go");			
		if(tableName!=null && tableName.equalsIgnoreCase("view_xbemy_qgzx_zdwhxxb")){
			input = new String[]{"xmdm", "xmmc", "zddm","zdmc","zdlx","zddx","bxwsz"};
		}
		if(tableName!=null && tableName.equalsIgnoreCase("xbemy_qgzx_zdyxmdmb")){
			input = new String[]{"xmdm","xmmc"};
		}
		if(go!=null && go.equalsIgnoreCase("go")){
			String[] colnumCN = dao.getColumnNameCN(input, tableName);
			topTr = dao.arrayToList(input, colnumCN);;
			rs = xbDao.selectInfo(form, tableName, input);
			rsNum = rs.size();
		}
		
		request.setAttribute("topTr",topTr);
		request.setAttribute("rsNum",rsNum);
		request.setAttribute("rs", rs);
	}
	
	/**
	 * 字段管理
	 * @throws Exception 
	 * */
	public ActionForward fieldManager(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {	
		XbemyQgzxForm xbForm = (XbemyQgzxForm)form;
		XbemyQgzxDAO qgzxDao = new XbemyQgzxDAO();
		List xmList = qgzxDao.getWhxmList();
		String doType = request.getParameter("doType"); 			
		boolean flag = false;
		//查询信息
		this.baseQueryAction(form, request);
		
		if(doType!=null && "del".equalsIgnoreCase(doType)){
			String pkValue = request.getParameter("pkDel");
			String[] values = pkValue.split("!!splitOne!!");
			for(int i=0; i<values.length-1; i++){
				//删除字段信息表中的记录
				String tableName = "xbemy_qgzx_zdwhxxb";
				xbForm.setZddm(values[i+1]);
				HashMap<String, String> tableInfo = qgzxDao.getTabNameByCode(form,"del");
				
				flag = StandardOperation.delete(tableName, "zddm", values[i+1], request);
				//删除字段
				if(flag){					
			        flag = qgzxDao.modifyTable(request,tableInfo, xbForm, "del");
				}
			}
			request.setAttribute("result", flag);
		}
		
		request.setAttribute("xmList", xmList);
		return mapping.findForward("field_manager");
	}
	
	/**
	 * @throws Exception 
	 * 字段维护
	 * */
	public ActionForward showFieldManager(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {		
		XbemyQgzxDAO qgzxDao = new XbemyQgzxDAO();
		HashMap<String, String> rs = new HashMap<String, String>();
		boolean flag = false;
		List xmList = qgzxDao.getWhxmList();
		String doType = request.getParameter("doType");
		String act = request.getParameter("act");	
		String tableName = "xbemy_qgzx_zdwhxxb";
		
		if(doType!=null && "view".equalsIgnoreCase(doType)){
			//显示信息
			tableName = "view_xbemy_qgzx_zdwhxxb";
			String pk = "zddm";
			String pkValue = DealString.toGBK(request.getParameter("pkValue")).trim();
			String[] input = {"xmmc","xmdm","zddm","zdmc","zddx","zdlx","bxwsz"};
		    rs = qgzxDao.getInfoByPk(tableName, pk, pkValue, input);
		}
		if(doType!=null && "save".equalsIgnoreCase(doType)){
			//保存字段信息
			String[] pk = {"zddm"};
			String[] input = {"xmdm","zddm","zdmc","zdlx","zddx","bxwsz"};
			flag = qgzxDao.saveInfo(request, form, tableName, pk, input);
			
			//将添加的字段增加到相应的表中
			if(flag){				
				HashMap<String, String> tableInfo = qgzxDao.getTabNameByCode(form);
				flag = qgzxDao.modifyTable(request,tableInfo, form, act);
			}
			request.setAttribute("result", flag);
		}
		
		request.setAttribute("rs", rs);
		request.setAttribute("act", act);
		request.setAttribute("xmList", xmList);
		return mapping.findForward("show_file_info");
	}
	
	/**
	 *报表管理 
	**/
	public ActionForward reportManager(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {	
		XbemyQgzxDAO qgzxDao = new XbemyQgzxDAO();
		List xmList = qgzxDao.getWhxmList();
		//查询信息
		this.baseQueryAction(form, request);
		
		request.setAttribute("xmList", xmList);
		return mapping.findForward("report_manager");
	}
	
	/**
	 * 报表维护
	 * */
	public ActionForward showReportManager(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {	
		XbemyQgzxDAO xbDao = new XbemyQgzxDAO();
		boolean flag = false;
		String xmdm = request.getParameter("xmdm").trim();
		String xmmc = DealString.toGBK(request.getParameter("xmmc"));
		String doType = request.getParameter("doType");
		String content1 = "";
		
		
		if(doType!=null && doType.equalsIgnoreCase("save")){
			content1 = DealString.toGBK(request.getParameter("content1"));
			flag = StandardOperation.update("xbemy_qgzx_zdyxmdmb", new String[]{"bbwbgs"}, new String[]{content1}, "xmdm", xmdm, request);
			request.setAttribute("result", flag);
		}
		
		content1 = xbDao.getInfoByPk("xbemy_qgzx_zdyxmdmb", "xmdm", xmdm, new String[]{"bbwbgs"}).get("bbwbgs");
		content1 = content1 == null ? "" : content1;
		request.setAttribute("xmdm", xmdm);
		request.setAttribute("xmmc", xmmc);
		request.setAttribute("content1", content1);
		return mapping.findForward("show_report_info");
	}

	/**
	 * 岗位信息报表
	 * */
	
	public ActionForward printGwxx(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		HashMap<String, String> map = new HashMap<String, String>();
		XbemyQgzxDAO xbDao = new XbemyQgzxDAO();
		String tableName = request.getParameter("tabName");
		String pk = request.getParameter("dyxmdm");
		String xh = request.getParameter("xh");
		pk = pk==null || "".equalsIgnoreCase(pk) ?  "" : pk.trim(); 
		
		String[] input = xbDao.getColumnByTabName(tableName);
		String[] out = new String[input.length];
		String htmlStr = xbDao.getInfoByPk("xbemy_qgzx_zdyxmdmb", "xmdm", pk, new String[]{"bbwbgs"}).get("bbwbgs");
		
		for(int i=0; i<input.length; i++){
			String temp = input[i].toLowerCase();
			temp = temp == null ? "" : temp.trim();
			String str = request.getParameter(temp);
			str = str==null ? "" : str;
			map.put(temp, DealString.toGBK(str));
			out[i] = "${rs." + input[i].toLowerCase() + "}";
		}
		
		//学生基本信息
		if(xh!=null && !"".equalsIgnoreCase(xh)){
			String[] inputV = {"xh","xm","xb","zymc","xymc","bjmc","xz"};
			HashMap<String, String> stuInfo = xbDao.getInfoByPk("view_xsjbxx", "xh", xh, inputV);
			for(int i=0; i<inputV.length; i++){
				String temStr = stuInfo.get(inputV[i]);
				temStr = temStr == null || "".equalsIgnoreCase(temStr) ? "" : temStr;
				if (temStr != null && !(temStr.equals(""))) {
					htmlStr = htmlStr.replace("${rs." + input[i] + "}", temStr);
				} else {
					htmlStr = htmlStr.replace("${rs." + input[i] + "}", " ");
				}
			}
		}
		
		for (int i = 0; i < input.length; i++) {
			String temp = input[i].toLowerCase();
			temp = temp==null? "" : temp;
			String tempStr = map.get(temp);
			if (tempStr != null && !(tempStr.equals(""))) {
				htmlStr = htmlStr.replace(out[i], tempStr);
			} else {
				htmlStr = htmlStr.replace(out[i], " ");
			}
		}
		htmlStr = htmlStr == null || "".equalsIgnoreCase(htmlStr) ? "" : htmlStr;
		request.setAttribute("htmlStr", htmlStr);
		request.setAttribute("rs", map);
		return mapping.findForward("print_gwxx");
	}
}