/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.xszz.zzxmtj;

import java.io.File;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import jxl.write.WritableWorkbook;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import xgxt.action.BaseAction;
import xgxt.utils.ExcelMethods;
import xgxt.utils.FormModleCommon;

/** 
 * MyEclipse Struts
 * Creation date: 10-09-2010
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class XszzZzxmtjAction extends BaseAction {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method zzxmtj
	 * 资助项目统计
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 * @throws Exception 
	 */
	public ActionForward zzxmtj(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		HttpSession session=request.getSession();
		XszzZzxmService service =new XszzZzxmService();
		XszzZzxmtjForm xszzZzxmForm=(XszzZzxmtjForm)form;
		
		String userType=(String) session.getAttribute("userType");
		String userDep = (String) session.getAttribute("userDep");
		String userName=(String) session.getAttribute("userName");
		String doType=request.getParameter("doType");
		
		String lx="";
		
		boolean fdyQx = Boolean.parseBoolean(session.getAttribute("fdyQx")
				.toString());
		// 班主任权限
		boolean bzrQx = Boolean.parseBoolean(session.getAttribute("bzrQx")
				.toString());
		if (bzrQx && fdyQx) {// 班主任兼辅导员
			lx = "jd";
		} else if (fdyQx) {// 辅导员
			lx = "fdy";
		} else if (bzrQx) {// 班主任
			lx = "bzr";
		} else if ("xy".equalsIgnoreCase(userType)) {// 学院
			lx = "xy";
		} else if ("xx".equalsIgnoreCase(userType)
				|| "admin".equalsIgnoreCase(userType)) {// 学校用户（管理员）
			lx = "xx";
		}
		
		if("qry".equalsIgnoreCase(doType)){
			service.zzxmTjCx(xszzZzxmForm,request,lx,userName);
		}
		
		request.setAttribute("path", "xszzZzxmtj.do?method=zzxmtj");
		
		
		FormModleCommon.commonRequestSet(request);
		FormModleCommon.setNdXnXqList(request);
		FormModleCommon.setNjXyZyBjListForFdyBzr(request);
		request.setAttribute("zzxmList", service.getZzxmList());
		request.setAttribute("xmdjList", service.getXmdjList(xszzZzxmForm.getZzxm()));
		xszzZzxmForm.setQuery_xydm(userDep);
		xszzZzxmForm.setXzx(xszzZzxmForm.getXzx());
		xszzZzxmForm.setXmdj(xszzZzxmForm.getXmdj());
		return mapping.findForward("zzxmtj");
	}
	
	public ActionForward zzxmTjbb(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
			
		HttpSession session=request.getSession();
			XszzZzxmService service =new XszzZzxmService();
			XszzZzxmtjForm xszzZzxmForm=(XszzZzxmtjForm)form;
			
			String userType=session.getAttribute("userType").toString();
			String userDep = session.getAttribute("userDep").toString();
			String userName=session.getAttribute("userName").toString();
			
			String lx="";
				
			boolean fdyQx = Boolean.parseBoolean(session.getAttribute("fdyQx")
					.toString());
			// 班主任权限
			boolean bzrQx = Boolean.parseBoolean(session.getAttribute("bzrQx")
					.toString());
			if (bzrQx && fdyQx) {// 班主任兼辅导员
				lx = "jd";
			} else if (fdyQx) {// 辅导员
				lx = "fdy";
			} else if (bzrQx) {// 班主任
				lx = "bzr";
			} else if ("xy".equalsIgnoreCase(userType)) {// 学院
				lx = "xy";
				xszzZzxmForm.setXydm(userDep);
			} else if ("xx".equalsIgnoreCase(userType)
					|| "admin".equalsIgnoreCase(userType)) {// 学校用户（管理员）
				lx = "xx";
			}
			
			String modelPath =servlet.getServletContext().getRealPath("") + "/print/xszz/zzxmTjbb.xls";
			response.setContentType("application/vnd.ms-excel");
			
			WritableWorkbook wwb = ExcelMethods.getWritableWorkbook(new File(modelPath), response.getOutputStream());
		    service.printZzxmTjbb(xszzZzxmForm,request, wwb,lx,userName);
		    return mapping.findForward("");
	}
}