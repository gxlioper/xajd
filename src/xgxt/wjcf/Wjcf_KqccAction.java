/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package xgxt.wjcf;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import common.Globals;

import xgxt.DAO.DAO;
import xgxt.action.Base;
import xgxt.xljk.lrh_Util.util.lrh_commen_util;
import java.util.*;

/** 
 * MyEclipse Struts
 * Creation date: 08-21-2007
 * 
 * XDoclet definition:
 * @struts.action path="/Wjcf_Kqcc" name="wjcfForm" scope="request" validate="true"
 */
public class Wjcf_KqccAction extends Action {
	/*
	 * Generated Methods
	 */

	/** 
	 * Method execute
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		WjcfForm wjcfForm = (WjcfForm) form;// TODO Auto-generated method stub
		DAO dao = DAO.getInstance();
		try {
		    int i = Base.chkTimeOut(request.getSession());
		    if (i <= 2) {
		    	wjcfForm.setErrMsg("登陆超时，请重新登陆！");
			return new ActionForward("/login.jsp", false);
		    }

		    HttpSession session = request.getSession();
		    if (session == null) {
			request.setAttribute("errMsg", "sadfsdf");
			return mapping.findForward("false");
		    } 
		
			ActionForward myActFwd = null;
			String act = request.getParameter("act");
			String doType=request.getParameter("doType");
//		    String userName=session.getAttribute("userName").toString();
//			String userDep=session.getAttribute("userDep").toString();
//			String userNameReal=session.getAttribute("userNameReal").toString();
//			String userOnLine=session.getAttribute("userOnLine").toString();
		if (act.equals("wjcf_kqcc")) {
			String xxdm = dao.getXxdm();
			if (xxdm.equalsIgnoreCase(Globals.XXDM_SZXXZYJSXY)) {//是否是深圳信息学院
				return new ActionForward("/szzykqccdefault.do",false);
			}
			if(doType!=null&&!doType.equalsIgnoreCase(""))
			{
				if(doType.equals("kqcc_search"))
				{
					myActFwd = kqcc_search(mapping,form,request,response);	
				}
				else if(doType.equals("kqcc_view"))
				{
					myActFwd = kqcc_view(mapping,form,request,response);	
				}
				else if(doType.equals("kqcc_print"))
				{
					myActFwd = kqcc_print(mapping,form,request,response);	
				}
			}
			else
			{
				myActFwd = index_to_jsp(mapping,form,request,response);	
			}
		}
		return myActFwd;
		}
	catch(Exception e){
		e.printStackTrace();
		wjcfForm.setErrMsg("数据连接中断，请重新登陆！");
    	return new ActionForward("/login.jsp", false);
		}
	}
	
	private ActionForward index_to_jsp(ActionMapping mapping, ActionForm form,
    	    HttpServletRequest request, HttpServletResponse response)
    	    throws Exception {
			HttpSession session = request.getSession();
			String userName=session.getAttribute("userName").toString();
//			String userDep=session.getAttribute("userDep").toString();
			WjcfForm myform = (WjcfForm)form;
			String dyym="Wjcf_Kqcc.do?act=wjcf_kqcc";
			lrh_commen_util commen_util= new lrh_commen_util();
			myform.deal_gbk();
			boolean writeflag=commen_util.checkUsrPower2(userName, dyym);
			request.setAttribute("xnList", commen_util.get_xnndList());
			request.setAttribute("xqList", commen_util.get_xqList());
			request.setAttribute("njList", commen_util.get_njList());
			request.setAttribute("xyList", commen_util.get_xyList());
			request.setAttribute("zyList", commen_util.get_zyList(myform.getXydm()));
			request.setAttribute("bjList", commen_util.get_bjList2(myform.getXydm(),myform.getZydm(),myform.getNj()));
			
			if(true==writeflag)
			{
				request.setAttribute("realTable", "WJCF_XSKQCCB");
				request.setAttribute("writeAble", "yes");
			}
			myform.setTableName("WJCF_XSKQCCB");
			return mapping.findForward("index_to_jsp");
	}
	
	private ActionForward kqcc_search(ActionMapping mapping, ActionForm form,
    	    HttpServletRequest request, HttpServletResponse response)
    	    throws Exception {
			HttpSession session = request.getSession();
			String userName=session.getAttribute("userName").toString();
//			String userDep=session.getAttribute("userDep").toString();
			WjcfForm myform = (WjcfForm)form;
			String dyym="Wjcf_Kqcc.do?act=wjcf_kqcc";
			WjcfUtil myutil=new WjcfUtil();
			myutil.WjcfUtil1(request);
			lrh_commen_util commen_util= new lrh_commen_util();
			myform.deal_gbk();
			List li=myutil.kqcc_search(myform);
			String rsNum=String.valueOf(li.size());
			String []zdm={"NJ","XYMC","ZYMC","BJMC","KCMC","RS","SDRS","QJRS","QQ","CQL","RQ","SJD"};
			//String []zdm={"SKDD","XYMC","BJMC","bzr","rkjs","KCMC","RS","SDRS","cql","qq","qjrs","kqy"};
			List topTr=commen_util.Get_Table_Title("VIEW_XSKQXX", zdm);
			boolean writeflag=commen_util.checkUsrPower2(userName, dyym);
			myform.setTableName("WJCF_XSKQCCB");
			request.setAttribute("rs", li);
			request.setAttribute("rsNum",rsNum);
			request.setAttribute("topTr",topTr);
			request.setAttribute("xnList", commen_util.get_xnndList());
			request.setAttribute("xqList", commen_util.get_xqList());
			request.setAttribute("njList", commen_util.get_njList());
			request.setAttribute("xyList", commen_util.get_xyList());
			request.setAttribute("zyList", commen_util.get_zyList(myform.getXydm()));
			request.setAttribute("bjList", commen_util.get_bjList2(myform.getXydm(),myform.getZydm(),myform.getNj()));
			if(true==writeflag)
			{
				request.setAttribute("realTable", "WJCF_XSKQCCB");
				request.setAttribute("writeAble", "yes");
			}
			return mapping.findForward("index_to_jsp");
	}
	
	private ActionForward kqcc_view(ActionMapping mapping, ActionForm form,
    	    HttpServletRequest request, HttpServletResponse response)
    	    throws Exception {
//			HttpSession session = request.getSession();
//			String userName=session.getAttribute("userName").toString();
//			String userDep=session.getAttribute("userDep").toString();
			WjcfForm myform = (WjcfForm)form;
			myform.deal_gbk();
//			lrh_commen_util commen_util= new lrh_commen_util();
			WjcfUtil myutil=new WjcfUtil();
			String xn_id=request.getParameter("xn_id");
			myform.setXn_id(xn_id);
			myform=myutil.kqcc_view(myform);
			return mapping.findForward("kqcc_view");
	}
	
	private ActionForward kqcc_print(ActionMapping mapping, ActionForm form,
    	    HttpServletRequest request, HttpServletResponse response)
	{
//		HttpSession session = request.getSession();
		WjcfForm myform = (WjcfForm)form;
//		String dyym="Wjcf_Kqcc.do?act=wjcf_kqcc";
		WjcfUtil myutil=new WjcfUtil();
		lrh_commen_util commen_util= new lrh_commen_util();
		myform.deal_gbk();
		List li=myutil.kqcc_search(myform);
		String rsNum=String.valueOf(li.size());
		String []zdm={"NJ","XYMC","ZYMC","BJMC","KCMC","RS","SDRS","QJRS","QQ","CQL","RQ","SJD"};
		List topTr=commen_util.Get_Table_Title("VIEW_XSKQXX", zdm);
		myform.setTableName("WJCF_XSKQCCB");
		if(null!=li)
		{
			request.setAttribute("rs", li);
			request.setAttribute("rsNum",rsNum);
			request.setAttribute("topTr",topTr);
		}
		request.setAttribute("realTable", myform.getTableName());
		return mapping.findForward("kqcc_print");
	}
	
}